{"paragraphs":[{"text":"%livy.pyspark\n\n\n\"\"\"\n%livy.pyspark\n\n('spark.executor.cores', '2')\n('spark.executor.memory', '8G')\n('spark.driver.memory', '16G')\n('spark.executor.instances', '2')\n\"\"\"\n\n### Prueba de Sebastian\n\nimport pyspark # only run after findspark.init()\nfrom pyspark.sql import SparkSession\n\nspark = (SparkSession\n         .builder\n#  \t .config(\"spark.executor.cores\", 4)\n     .config(\"spark.executor.memory\", '16g')\n      # .config(\"spark.driver.memory\",'20g')\n   \t .config(\"spark.executor.instances\", 40)\n         .getOrCreate()) \nif 1 > 10:             \n    spark.conf.set(\"spark.executor.memory\", '20g')         \n    spark.conf.set(\"spark.executor.instances\", '4')\n    spark.conf.set(\"spark.executor.cores\", '4')\n\nspark.sparkContext.getConf().getAll()\n","user":"u632820","dateUpdated":"2022-10-05T16:19:48-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"[('spark.history.kerberos.keytab', 'none'), ('spark.eventLog.enabled', 'true'), ('spark.driver.memory', '16G'), ('spark.executorEnv.PYTHONPATH', '{{PWD}}/pyspark.zip<CPS>{{PWD}}/py4j-0.10.7-src.zip<CPS>{{PWD}}/pyspark.zip<CPS>{{PWD}}/py4j-0.10.7-src.zip'), ('spark.history.ui.port', '18081'), ('spark.driver.extraLibraryPath', '/usr/hdp/current/hadoop-client/lib/native:/usr/hdp/current/hadoop-client/lib/native/Linux-amd64-64'), ('spark.history.fs.cleaner.interval', '7d'), ('spark.yarn.secondary.jars', 'livy-rsc-0.5.0.3.1.5.0-152.jar,livy-api-0.5.0.3.1.5.0-152.jar,netty-all-4.1.42.Final.jar,livy-repl_2.11-0.5.0.3.1.5.0-152.jar,commons-codec-1.9.jar,livy-core_2.11-0.5.0.3.1.5.0-152.jar,datanucleus-api-jdo-4.2.1.jar,datanucleus-core-4.1.6.jar,datanucleus-rdbms-4.1.7.jar'), ('spark.yarn.queue', 'ZEPPELIN'), ('spark.dynamicAllocation.initialExecutors', '4'), ('spark.shuffle.io.serverThreads', '128'), ('spark.submit.pyFiles', '/usr/hdp/current/spark2-client/python/lib/pyspark.zip,/usr/hdp/current/spark2-client/python/lib/py4j-0.10.7-src.zip'), ('spark.deployMode', 'cluster'), ('spark.repl.class.outputDir', '/tmp/spark803794516854709423'), ('spark.executor.extraLibraryPath', '/usr/hdp/current/hadoop-client/lib/native:/usr/hdp/current/hadoop-client/lib/native/Linux-amd64-64'), ('spark.executor.memory', '16g'), ('spark.sql.streaming.streamingQueryListeners', ''), ('spark.shuffle.file.buffer', '1m'), ('spark.dynamicAllocation.maxExecutors', '32'), ('spark.pyspark.python', '/bin/python3'), ('spark.sql.hive.convertMetastoreOrc', 'true'), ('spark.driver.port', '48473'), ('spark.sql.autoBroadcastJoinThreshold', '26214400'), ('spark.ui.filters', 'org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter'), ('spark.eventLog.dir', 'hdfs:///spark2-history/'), ('spark.org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter.param.RM_HA_URLS', 'sr-hadctl-xp03.corp.cablevision.com.ar:8088,sr-hadctl-xp02.corp.cablevision.com.ar:8088'), ('spark.driver.extraClassPath', '/usr/lib/PLD/JARs/terajdbc4.jar:/usr/lib/PLD/JARs/tdgssconfig.jar:/usr/lib/PLD/JARs/ojdbc8.jar:/usr/lib/PLD/JARs/*'), ('spark.yarn.dist.pyFiles', 'file:///usr/hdp/current/spark2-client/python/lib/pyspark.zip,file:///usr/hdp/current/spark2-client/python/lib/py4j-0.10.7-src.zip'), ('spark.executor.id', 'driver'), ('spark.sql.orc.impl', 'native'), ('spark.yarn.dist.archives', 'file:/usr/hdp/current/spark2-client/R/lib/sparkr.zip#sparkr'), ('spark.jars', 'file:/usr/hdp/current/livy2-server/rsc-jars/livy-rsc-0.5.0.3.1.5.0-152.jar,file:/usr/hdp/current/livy2-server/rsc-jars/livy-api-0.5.0.3.1.5.0-152.jar,file:/usr/hdp/current/livy2-server/rsc-jars/netty-all-4.1.42.Final.jar,file:/usr/hdp/current/livy2-server/repl_2.11-jars/livy-repl_2.11-0.5.0.3.1.5.0-152.jar,file:/usr/hdp/current/livy2-server/repl_2.11-jars/commons-codec-1.9.jar,file:/usr/hdp/current/livy2-server/repl_2.11-jars/livy-core_2.11-0.5.0.3.1.5.0-152.jar,file:/usr/hdp/current/spark2-client/jars/datanucleus-api-jdo-4.2.1.jar,file:/usr/hdp/current/spark2-client/jars/datanucleus-core-4.1.6.jar,file:/usr/hdp/current/spark2-client/jars/datanucleus-rdbms-4.1.7.jar'), ('spark.app.name', 'livy-session-5'), ('spark.yarn.historyServer.address', 'sr-hadctl-xp03.corp.cablevision.com.ar:18081'), ('spark.repl.local.jars', 'file:///usr/hdp/current/livy2-server/rsc-jars/livy-rsc-0.5.0.3.1.5.0-152.jar,file:///usr/hdp/current/livy2-server/rsc-jars/livy-api-0.5.0.3.1.5.0-152.jar,file:///usr/hdp/current/livy2-server/rsc-jars/netty-all-4.1.42.Final.jar,file:///usr/hdp/current/livy2-server/repl_2.11-jars/livy-repl_2.11-0.5.0.3.1.5.0-152.jar,file:///usr/hdp/current/livy2-server/repl_2.11-jars/commons-codec-1.9.jar,file:///usr/hdp/current/livy2-server/repl_2.11-jars/livy-core_2.11-0.5.0.3.1.5.0-152.jar,file:///usr/hdp/current/spark2-client/jars/datanucleus-api-jdo-4.2.1.jar,file:///usr/hdp/current/spark2-client/jars/datanucleus-core-4.1.6.jar,file:///usr/hdp/current/spark2-client/jars/datanucleus-rdbms-4.1.7.jar'), ('spark.history.fs.logDirectory', 'hdfs:///spark2-history/'), ('spark.driver.host', 'sr-hadctl-xp05.corp.cablevision.com.ar'), ('spark.sql.catalogImplementation', 'hive'), ('spark.history.fs.cleaner.maxAge', '90d'), ('spark.livy.spark_major_version', '2'), ('spark.yarn.dist.files', 'file:///etc/spark2/3.1.5.0-152/0/hive-site.xml'), ('spark.pyspark.driver.python', '/bin/python3'), ('spark.extraListeners', ''), ('spark.org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter.param.PROXY_HOSTS', 'sr-hadctl-xp03.corp.cablevision.com.ar,sr-hadctl-xp02.corp.cablevision.com.ar'), ('spark.yarn.tags', 'livy-session-5-dR7yTW0D'), ('spark.history.store.path', '/var/lib/spark2/shs_db'), ('spark.dynamicAllocation.minExecutors', '4'), ('spark.yarn.submit.waitAppCompletion', 'false'), ('spark.executor.extraClassPath', '/usr/lib/PLD/JARs/terajdbc4.jar:/usr/lib/PLD/JARs/tdgssconfig.jar:/usr/lib/PLD/JARs/ojdbc8.jar'), ('spark.driver.appUIAddress', 'http://sr-hadctl-xp05.corp.cablevision.com.ar:4045'), ('spark.sql.warehouse.dir', '/warehouse/tablespace/managed/hive'), ('spark.sql.statistics.fallBackToHdfs', 'true'), ('spark.yarn.maxAppAttempts', '1'), ('spark.history.provider', 'org.apache.spark.deploy.history.FsHistoryProvider'), ('spark.submit.deployMode', 'client'), ('spark.executor.instances', '40'), ('spark.org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter.param.PROXY_URI_BASES', 'http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028,http://sr-hadctl-xp02.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028'), ('spark.sql.hive.metastore.jars', '/usr/hdp/current/spark2-client/standalone-metastore/*'), ('spark.yarn.appMasterEnv.PYSPARK_PYTHON', '/bin/python3'), ('spark.shuffle.service.enabled', 'true'), ('spark.executor.cores', '2'), ('spark.files', 'file:/etc/spark2/3.1.5.0-152/0/hive-site.xml'), ('spark.history.fs.cleaner.enabled', 'true'), ('spark.app.id', 'application_1663324482137_181028'), ('spark.sql.queryExecutionListeners', ''), ('spark.master', 'yarn'), ('spark.yarn.dist.jars', 'file:///usr/hdp/current/livy2-server/rsc-jars/livy-rsc-0.5.0.3.1.5.0-152.jar,file:///usr/hdp/current/livy2-server/rsc-jars/livy-api-0.5.0.3.1.5.0-152.jar,file:///usr/hdp/current/livy2-server/rsc-jars/netty-all-4.1.42.Final.jar,file:///usr/hdp/current/livy2-server/repl_2.11-jars/livy-repl_2.11-0.5.0.3.1.5.0-152.jar,file:///usr/hdp/current/livy2-server/repl_2.11-jars/commons-codec-1.9.jar,file:///usr/hdp/current/livy2-server/repl_2.11-jars/livy-core_2.11-0.5.0.3.1.5.0-152.jar,file:///usr/hdp/current/spark2-client/jars/datanucleus-api-jdo-4.2.1.jar,file:///usr/hdp/current/spark2-client/jars/datanucleus-core-4.1.6.jar,file:///usr/hdp/current/spark2-client/jars/datanucleus-rdbms-4.1.7.jar'), ('spark.io.compression.lz4.blockSize', '128kb'), ('spark.repl.class.uri', 'spark://sr-hadctl-xp05.corp.cablevision.com.ar:48473/classes'), ('spark.history.kerberos.principal', 'none'), ('spark.sql.orc.filterPushdown', 'true'), ('spark.ui.proxyBase', '/proxy/application_1663324482137_181028'), ('spark.shuffle.io.backLog', '8192'), ('spark.unsafe.sorter.spill.reader.buffer.size', '1m'), ('spark.dynamicAllocation.enabled', 'true'), ('spark.shuffle.unsafe.file.output.buffer', '5m'), ('spark.yarn.isPython', 'true'), ('spark.executor.extraJavaOptions', '-XX:+UseNUMA'), ('spark.sql.hive.metastore.version', '3.0')]"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664454487131_-787478096","id":"20220929-092807_702084004","dateCreated":"2022-09-29T09:28:07-0300","dateStarted":"2022-10-05T16:19:48-0300","dateFinished":"2022-10-05T16:20:31-0300","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:8144"},{"text":"%livy.pyspark\r\nimport pyspark\r\nfrom pyspark.sql import SparkSession\r\nfrom pyspark.sql.functions import lit, col, regexp_replace, trim\r\nfrom pyspark.sql.functions import unix_timestamp, from_unixtime, to_date\r\nfrom pyspark.sql import functions as F\r\nfrom pyspark.sql.window import Window\r\nfrom pyspark.sql.functions import first\r\nfrom pyspark.sql.types import IntegerType, LongType, FloatType\r\nimport sys\r\nfrom pyspark.mllib.stat import Statistics\r\nfrom pyspark.ml.classification import RandomForestClassifier, RandomForestClassificationModel\r\nfrom pyspark.ml.classification import GBTClassifier,GBTClassificationModel \r\nfrom pyspark.ml.feature import OneHotEncoder, StringIndexer, VectorAssembler, QuantileDiscretizer\r\nfrom pyspark.ml.tuning import ParamGridBuilder, CrossValidator\r\nfrom pyspark.ml import Pipeline\r\nfrom pyspark.ml.evaluation import BinaryClassificationEvaluator\r\n\r\nimport datetime \r\nfrom dateutil.relativedelta import *\r\nimport calendar\r\n\r\nfrom pyspark.sql import HiveContext\r\nhive_context = HiveContext(sc)\r\nhive_context.setConf(\"hive.exec.dynamic.partition\", \"true\") \r\nhive_context.setConf(\"hive.exec.dynamic.partition.mode\", \"nonstrict\") \r\nfrom xgboost import XGBClassifier","user":"u632820","dateUpdated":"2022-10-05T16:20:39-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664299294318_-1333662771","id":"20220809-085944_422084195","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-10-05T16:20:40-0300","dateFinished":"2022-10-05T16:20:42-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8145"},{"text":"%livy.pyspark\nSEED=84\nTARGET= 'label'\nCUTOFF=2.0\nVARIANCE = 2.0\nmodelo = \"CHURN_COMBO_CATVHD\"\nALGORITHM = 'RF'\ntipo = \"PERFORMANCE\"\n","user":"u632820","dateUpdated":"2022-10-05T16:20:42-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664299294338_514497746","id":"20220809-090002_1893492990","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-10-05T16:20:43-0300","dateFinished":"2022-10-05T16:20:44-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8146"},{"text":"%livy.pyspark\ndef get_period(prev_month=0, formatstr = '%Y%m'):\n    \n    period = datetime.datetime.now() - relativedelta(months=prev_month)\n    \n    return datetime.date(period.year, period.month, calendar.monthrange(period.year, period.month)[-1]).strftime(formatstr)\n","user":"u632820","dateUpdated":"2022-10-05T16:20:47-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664299294340_2115521652","id":"20220809-090000_2054326958","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-10-05T16:20:47-0300","dateFinished":"2022-10-05T16:20:48-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8147"},{"text":"%livy.pyspark\n\nPERIODO = get_period(1, '%Y%m') # periodo de corrida\n#PERIODO_VAL = get_period(11, '%Y%m')\nPERIODO_TRAIN1 = get_period(14, '%Y%m')\nPERIODO_TRAIN2 = get_period(13, '%Y%m')\nPERIODO_TRAIN3 = get_period(12, '%Y%m')\nPERIODO_TRAIN4 = get_period(11, '%Y%m')\nPERIODO_TRAIN5 = get_period(10, '%Y%m')\nPERIODO_TRAIN6 = get_period(9, '%Y%m')\n\n\n\nPERIODO_TEST1 = get_period(8, '%Y%m')\nPERIODO_TEST2 = get_period(7, '%Y%m')\nPERIODO_TEST3 = get_period(6, '%Y%m') # 6 meses para atras desde el periodo que se corre el proceso o desde el periodo que esta disponible el target\n\n\nprint(\"PERIODO: \",  PERIODO)\nprint(\"PERIODO_TRAIN1: \",  PERIODO_TRAIN1)\nprint(\"PERIODO_TRAIN2: \",  PERIODO_TRAIN2)\nprint(\"PERIODO_TRAIN3: \",  PERIODO_TRAIN3)\nprint(\"PERIODO_TRAIN4: \",  PERIODO_TRAIN4)\nprint(\"PERIODO_TRAIN5: \",  PERIODO_TRAIN5)\nprint(\"PERIODO_TRAIN6: \",  PERIODO_TRAIN6)\n#print(\"PERIODO_VAL: \",  PERIODO_VAL)\n\nprint(\"PERIODO_TEST1: \",  PERIODO_TEST1)\nprint(\"PERIODO_TEST2: \",  PERIODO_TEST2)\nprint(\"PERIODO_TEST3: \",  PERIODO_TEST3)","user":"u632820","dateUpdated":"2022-10-05T16:20:50-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"PERIODO:  202209\nPERIODO_TRAIN1:  202108\nPERIODO_TRAIN2:  202109\nPERIODO_TRAIN3:  202110\nPERIODO_TRAIN4:  202111\nPERIODO_TRAIN5:  202112\nPERIODO_TRAIN6:  202201\nPERIODO_TEST1:  202202\nPERIODO_TEST2:  202203\nPERIODO_TEST3:  202204"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664299294342_559633131","id":"20220809-090018_416228169","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-10-05T16:20:50-0300","dateFinished":"2022-10-05T16:20:51-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8148"},{"text":"%livy.pyspark\n\n# Numericas\nnumericas = ['sum_kb_down_weekend_m0', 'avg_zt_cli_viv_u6m', 'tend_zt_cli_viv_m6', 'avg_rxpower_up_madrugada_m0', 'avg_zt_tm_u6m', 'sum_kb_up_noche_m0', 'prod_catv_antiq', 'avg_tot_tipo_prod_catv_totales_danio_u6m', 'prod_cm_sum_days_danio_cerrado_m0', 'ranking_gam', 'tend_kb_down_total_m6', 'antiq_cm_zt_m0', 'antiq_enabled_dignet_zt_m0', 'prod_cm_antiq', 'antiq_enabled_serv_zt_m0', 'avg_zt_cli_kms_u3m', 'compgte_prop_weekend_kb_up_m1', 'avg_tot_tipo_prod_cm_cerrado_danio_u6m', 'antiguedad_cliente']\n\n\n# Categoricas\ncategoricas = ['flg_flex', 'flg_digital', 'intencion_baja_catv_m0', 'intencion_baja_premium_m0', 'intencion_baja_catvpremium_m0', 'mudanza_catv_m0', 'ret_catv_m0', 'ret_premium_m0', 'ret_catvpremium_m0', 'mora_catv_m0', 'mora_premium_m0', 'mora_catvpremium_m0', 'error_baja_monto_prodcatv_bin', 'error_factura_monto_prodcatv_bin', 'error_promo_monto_prodcatv_bin', 'error_instalac_monto_prodcatv_bin', 'dias_sserv_monto_prodcatv_bin', 'otro_monto_prodcatv_bin', 'provincia_encoded', 'provincia_subregion_encoded', 'metodo_pago_encoded', 'tipo_residencia_encoded', 'sexo_encoded', 'flg_converge_cv', 'flg_converge_tp', 'f_arnet', 'f_club_personal_ok', 'f_personal_video_ok', 'f_pospago', 'f_prepago', 'cobre', 'claro', 'movi', 'telecentro', 'gigared', 'supercanal', 'express', 'locales', 'sum_tot_importe_arpu_bin_m0', 'sum_tot_core_arpu_bin_m0', 'sum_tot_promos_arpu_bin_m0', 'sum_tot_desc_mult_arpu_bin_m0', 'sum_factura_monto_bruto_m0_bin_m0', 'sum_factura_monto_neto_m0_bin_m0', 'sum_factura_monto_descontado_m0_bin_m0', 'sum_factura_monto_bonif_m0_bin_m0', 'sum_factura_monto_bruto_m1_bin_m0', 'sum_factura_monto_neto_m1_bin_m0', 'sum_factura_monto_descontado_m1_bin_m0', 'diff_factura_monto_neto_m1_bin_m0', 'diff_factura_monto_bruto_m1_bin_m0', 'diff_factura_monto_descontado_m1_bin_m0', 'sum_tot_importe_bin', 'sum_tot_importe_cobrador_bin', 'sum_tot_importe_electronico_bin', 'sum_tot_importe_sucursal_bin', 'sum_tot_importe_uruguay_bin', 'sum_tot_importe_ventanilla_bin', 'sum_tot_importe_debito_bin', 'diff_tot_importe_bin_m1', 'diff_tot_importe_bin_m3', 'diff_tot_importe_bin_m6', 'diff_tot_importe_cobrador_bin_m1', 'diff_tot_importe_cobrador_bin_m3', 'diff_tot_importe_cobrador_bin_m6', 'diff_tot_importe_electronico_bin_m1', 'diff_tot_importe_electronico_bin_m3', 'diff_tot_importe_electronico_bin_m6', 'diff_tot_importe_sucursal_bin_m1', 'diff_tot_importe_sucursal_bin_m3', 'diff_tot_importe_sucursal_bin_m6', 'diff_tot_importe_uruguay_bin_m1', 'diff_tot_importe_uruguay_bin_m3', 'diff_tot_importe_uruguay_bin_m6', 'diff_tot_importe_ventanilla_bin_m1', 'diff_tot_importe_ventanilla_bin_m3', 'diff_tot_importe_ventanilla_bin_m6', 'diff_tot_importe_debito_bin_m1', 'diff_tot_importe_debito_bin_m3', 'diff_tot_importe_debito_bin_m6', 'antic_mora_0_30_t_ohe_m0', 'antic_mora_30_60_t_ohe_m0', 'antic_mora_60_90_t_ohe_m0', 'antic_mora_90_120_t_ohe_m0', 'antic_mora_m120_t_ohe_m0', 'upgrade_cm_m0', 'downgrade_cm_m0', 'intencion_baja_cm_m0', 'mudanza_cm_m0', 'ret_cm_m0', 'mora_cm_m0', 'cat_str_null_ohe', 'cat_str_full_user_ohe', 'cat_str_hard_mid_user_ohe', 'cat_str_heavy_user_ohe', 'cat_str_low_mid_user_ohe', 'cat_str_low_user_ohe', 'cat_str_mid_user_ohe', 'cat_gam_null_ohe', 'cat_gam_full_user_ohe', 'cat_gam_hard_mid_user_ohe', 'cat_gam_heavy_user_ohe', 'cat_gam_low_mid_user_ohe', 'cat_gam_low_user_ohe', 'cat_gam_mid_user_ohe', 'cat_rrss_null_ohe', 'cat_rrss_full_user_ohe', 'cat_rrss_hard_mid_user_ohe', 'cat_rrss_heavy_user_ohe', 'cat_rrss_low_mid_user_ohe', 'cat_rrss_low_user_ohe', 'cat_rrss_mid_user_ohe', 'error_baja_monto_prodcm_bin', 'error_factura_monto_prodcm_bin', 'error_promo_monto_prodcm_bin', 'error_instalac_monto_prodcm_bin', 'dias_sserv_monto_prodcm_bin', 'otro_monto_prodcm_bin', 'provincia_zona']\n\n\n# Binarizadas\nflags =  ['flag_cumsum_intencion_baja_catv_u6m', 'flag_sum_tot_tipo_prod_catv_totales_danio_m0', 'flag_prod_catv_sum_days_danio_cerrado_m0', 'flag_prod_catv_sum_days_danio_abierto_m0', 'flag_sum_acum_tot_tipo_prod_catv_totales_danio_u6m', 'flag_num_promos_vigentes_prod_all_nomain_m0', 'flag_num_promos_fide_prod_all_main_m0', 'flag_numacum_promos_fide_prod_all_main_u6m', 'flag_num_days_fin_promo_prod_all_main_m0', 'flag_sum_days_paid_delay_m0', 'flag_sum_importe_saldo_antiq_m0', 'flag_sumacum_interact_gestiones_especiales_u6m', 'flag_sumacum_interact_fija_u6m', 'flag_cumsum_upgrade_cm_u6m', 'flag_sum_tot_tipo_prod_cm_abierto_danio_m0', 'flag_sum_tot_tipo_prod_cm_cerrado_danio_m0', 'flag_sum_tot_tipo_prod_cm_infundado_danio_m0', 'flag_prod_cm_sum_days_danio_cerrado_m0', 'flag_prod_cm_sum_days_danio_abierto_m0', 'flag_sum_acum_tot_tipo_prod_cm_abierto_danio_u6m', 'flag_sum_acum_tot_tipo_prod_cm_cerrado_danio_u6m', 'flag_sum_acum_tot_tipo_prod_cm_infundado_danio_u6m', 'flag_sum_acum_tot_tipo_prod_catv_Abierto_danio_u6m']\n","user":"u632820","dateUpdated":"2022-09-30T16:12:59-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_117086<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_117086/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_117086/</a>"}]},"apps":[],"jobName":"paragraph_1664299294344_-1288297590","id":"20220809-090038_1186992811","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-09-29T16:42:05-0300","dateFinished":"2022-09-29T16:42:06-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8149"},{"text":"%md\n\n# Si hay variables que son flags o binarias verificar que no sean Bigint\n## Si es posible no tener bigint mejor!\n","user":"u632820","dateUpdated":"2022-10-04T13:57:43-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Si hay variables que son flags o binarias verificar que no sean Bigint</h1>\n<h2>Si es posible no tener bigint mejor!</h2>\n</div>"}]},"apps":[],"jobName":"paragraph_1664902594782_-422857354","id":"20221004-135634_1546847364","dateCreated":"2022-10-04T13:56:34-0300","dateStarted":"2022-10-04T13:57:31-0300","dateFinished":"2022-10-04T13:57:31-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8150"},{"text":"%livy.pyspark\n\n# CARGO ABT PRODUCTIVA \n\nabt_df= spark.sql(f\"\"\"\nSELECT \nid_suscripcion, origin, sum_kb_down_weekend_m0, avg_zt_cli_viv_u6m, tend_zt_cli_viv_m6, avg_rxpower_up_madrugada_m0, avg_zt_tm_u6m, sum_kb_up_noche_m0, prod_catv_antiq, avg_tot_tipo_prod_catv_totales_danio_u6m, prod_cm_sum_days_danio_cerrado_m0, ranking_gam, tend_kb_down_total_m6, antiq_cm_zt_m0, antiq_enabled_dignet_zt_m0, prod_cm_antiq, antiq_enabled_serv_zt_m0, avg_zt_cli_kms_u3m, compgte_prop_weekend_kb_up_m1, avg_tot_tipo_prod_cm_cerrado_danio_u6m, antiguedad_cliente, flg_flex, flg_digital, intencion_baja_catv_m0, intencion_baja_premium_m0, intencion_baja_catvpremium_m0, mudanza_catv_m0, ret_catv_m0, ret_premium_m0, ret_catvpremium_m0, mora_catv_m0, mora_premium_m0, mora_catvpremium_m0, error_baja_monto_prodcatv_bin, error_factura_monto_prodcatv_bin, error_promo_monto_prodcatv_bin, error_instalac_monto_prodcatv_bin, dias_sserv_monto_prodcatv_bin, otro_monto_prodcatv_bin, provincia_encoded, provincia_subregion_encoded, metodo_pago_encoded, tipo_residencia_encoded, sexo_encoded, flg_converge_cv, flg_converge_tp, f_arnet, f_club_personal_ok, f_personal_video_ok, f_pospago, f_prepago, cobre, claro, movi, telecentro, gigared, supercanal, express, locales, sum_tot_importe_arpu_bin_m0, sum_tot_core_arpu_bin_m0, sum_tot_promos_arpu_bin_m0, sum_tot_desc_mult_arpu_bin_m0, sum_factura_monto_bruto_m0_bin_m0, sum_factura_monto_neto_m0_bin_m0, sum_factura_monto_descontado_m0_bin_m0, sum_factura_monto_bonif_m0_bin_m0, sum_factura_monto_bruto_m1_bin_m0, sum_factura_monto_neto_m1_bin_m0, sum_factura_monto_descontado_m1_bin_m0, diff_factura_monto_neto_m1_bin_m0, diff_factura_monto_bruto_m1_bin_m0, diff_factura_monto_descontado_m1_bin_m0, sum_tot_importe_bin, sum_tot_importe_cobrador_bin, sum_tot_importe_electronico_bin, sum_tot_importe_sucursal_bin, sum_tot_importe_uruguay_bin, sum_tot_importe_ventanilla_bin, sum_tot_importe_debito_bin, diff_tot_importe_bin_m1, diff_tot_importe_bin_m3, diff_tot_importe_bin_m6, diff_tot_importe_cobrador_bin_m1, diff_tot_importe_cobrador_bin_m3, diff_tot_importe_cobrador_bin_m6, diff_tot_importe_electronico_bin_m1, diff_tot_importe_electronico_bin_m3, diff_tot_importe_electronico_bin_m6, diff_tot_importe_sucursal_bin_m1, diff_tot_importe_sucursal_bin_m3, diff_tot_importe_sucursal_bin_m6, diff_tot_importe_uruguay_bin_m1, diff_tot_importe_uruguay_bin_m3, diff_tot_importe_uruguay_bin_m6, diff_tot_importe_ventanilla_bin_m1, diff_tot_importe_ventanilla_bin_m3, diff_tot_importe_ventanilla_bin_m6, diff_tot_importe_debito_bin_m1, diff_tot_importe_debito_bin_m3, diff_tot_importe_debito_bin_m6, antic_mora_0_30_t_ohe_m0, antic_mora_30_60_t_ohe_m0, antic_mora_60_90_t_ohe_m0, antic_mora_90_120_t_ohe_m0, antic_mora_m120_t_ohe_m0, upgrade_cm_m0, downgrade_cm_m0, intencion_baja_cm_m0, mudanza_cm_m0, ret_cm_m0, mora_cm_m0, cat_str_null_ohe, cat_str_full_user_ohe, cat_str_hard_mid_user_ohe, cat_str_heavy_user_ohe, cat_str_low_mid_user_ohe, cat_str_low_user_ohe, cat_str_mid_user_ohe, cat_gam_null_ohe, cat_gam_full_user_ohe, cat_gam_hard_mid_user_ohe, cat_gam_heavy_user_ohe, cat_gam_low_mid_user_ohe, cat_gam_low_user_ohe, cat_gam_mid_user_ohe, cat_rrss_null_ohe, cat_rrss_full_user_ohe, cat_rrss_hard_mid_user_ohe, cat_rrss_heavy_user_ohe, cat_rrss_low_mid_user_ohe, cat_rrss_low_user_ohe, cat_rrss_mid_user_ohe, error_baja_monto_prodcm_bin, error_factura_monto_prodcm_bin, error_promo_monto_prodcm_bin, error_instalac_monto_prodcm_bin, dias_sserv_monto_prodcm_bin, otro_monto_prodcm_bin, provincia_zona, flag_cumsum_intencion_baja_catv_u6m, flag_sum_tot_tipo_prod_catv_totales_danio_m0, flag_prod_catv_sum_days_danio_cerrado_m0, flag_prod_catv_sum_days_danio_abierto_m0, flag_sum_acum_tot_tipo_prod_catv_totales_danio_u6m, flag_num_promos_vigentes_prod_all_nomain_m0, flag_num_promos_fide_prod_all_main_m0, flag_numacum_promos_fide_prod_all_main_u6m, flag_num_days_fin_promo_prod_all_main_m0, flag_sum_days_paid_delay_m0, flag_sum_importe_saldo_antiq_m0, flag_sumacum_interact_gestiones_especiales_u6m, flag_sumacum_interact_fija_u6m, flag_cumsum_upgrade_cm_u6m, flag_sum_tot_tipo_prod_cm_abierto_danio_m0, flag_sum_tot_tipo_prod_cm_cerrado_danio_m0, flag_sum_tot_tipo_prod_cm_infundado_danio_m0, flag_prod_cm_sum_days_danio_cerrado_m0, flag_prod_cm_sum_days_danio_abierto_m0, flag_sum_acum_tot_tipo_prod_cm_abierto_danio_u6m, flag_sum_acum_tot_tipo_prod_cm_cerrado_danio_u6m, flag_sum_acum_tot_tipo_prod_cm_infundado_danio_u6m, flag_sum_acum_tot_tipo_prod_catv_Abierto_danio_u6m, periodo\nFROM sdb_datamining.tempna_abtimputadaCATVHD2_m\nWHERE periodo in {PERIODO_TRAIN1, PERIODO_TRAIN2, PERIODO_TRAIN3, PERIODO_TRAIN4, PERIODO_TRAIN5, PERIODO_TRAIN6}\n\"\"\"\n)","user":"u632820","dateUpdated":"2022-10-04T14:00:26-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_162967<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/</a>"}]},"apps":[],"jobName":"paragraph_1664902766536_-1836089691","id":"20221004-135926_1236129237","dateCreated":"2022-10-04T13:59:26-0300","dateStarted":"2022-10-04T14:00:15-0300","dateFinished":"2022-10-04T14:01:22-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8151"},{"text":"%livy.pyspark\n\nimport pandas as pd\n\na = pd.DataFrame(abt_df.dtypes)\na.columns = ['columna', 'tipo']\na.columns\n\n","user":"u632820","dateUpdated":"2022-10-04T14:01:02-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Index(['columna', 'tipo'], dtype='object')"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_162967<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/</a>"}]},"apps":[],"jobName":"paragraph_1664902657844_1627586340","id":"20221004-135737_803261999","dateCreated":"2022-10-04T13:57:37-0300","dateStarted":"2022-10-04T14:01:02-0300","dateFinished":"2022-10-04T14:01:23-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8152"},{"text":"%livy.pyspark\r\n\r\na.tipo.value_counts()\r\n","user":"u632820","dateUpdated":"2022-10-04T14:01:04-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"double           70\nint              51\nbigint           41\ndecimal(11,1)     1\nstring            1\nName: tipo, dtype: int64"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_162967<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/</a>"}]},"apps":[],"jobName":"paragraph_1664902745821_1075832199","id":"20221004-135905_563272367","dateCreated":"2022-10-04T13:59:05-0300","dateStarted":"2022-10-04T14:01:22-0300","dateFinished":"2022-10-04T14:01:24-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8153"},{"text":"%livy.pyspark\r\n\r\na[a.tipo == 'bigint']['columna']","user":"u632820","dateUpdated":"2022-10-04T14:02:06-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"0                     id_suscripcion\n23            intencion_baja_catv_m0\n24         intencion_baja_premium_m0\n25     intencion_baja_catvpremium_m0\n26                   mudanza_catv_m0\n27                       ret_catv_m0\n28                    ret_premium_m0\n29                ret_catvpremium_m0\n30                      mora_catv_m0\n31                   mora_premium_m0\n32               mora_catvpremium_m0\n39                 provincia_encoded\n40       provincia_subregion_encoded\n41               metodo_pago_encoded\n106                    upgrade_cm_m0\n107                  downgrade_cm_m0\n108             intencion_baja_cm_m0\n109                    mudanza_cm_m0\n110                        ret_cm_m0\n111                       mora_cm_m0\n112                 cat_str_null_ohe\n113            cat_str_full_user_ohe\n114        cat_str_hard_mid_user_ohe\n115           cat_str_heavy_user_ohe\n116         cat_str_low_mid_user_ohe\n117             cat_str_low_user_ohe\n118             cat_str_mid_user_ohe\n119                 cat_gam_null_ohe\n120            cat_gam_full_user_ohe\n121        cat_gam_hard_mid_user_ohe\n122           cat_gam_heavy_user_ohe\n123         cat_gam_low_mid_user_ohe\n124             cat_gam_low_user_ohe\n125             cat_gam_mid_user_ohe\n126                cat_rrss_null_ohe\n127           cat_rrss_full_user_ohe\n128       cat_rrss_hard_mid_user_ohe\n129          cat_rrss_heavy_user_ohe\n130        cat_rrss_low_mid_user_ohe\n131            cat_rrss_low_user_ohe\n132            cat_rrss_mid_user_ohe\nName: columna, dtype: object"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_162967<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/</a>"}]},"apps":[],"jobName":"paragraph_1664902756630_1903671775","id":"20221004-135916_105860463","dateCreated":"2022-10-04T13:59:16-0300","dateStarted":"2022-10-04T14:02:06-0300","dateFinished":"2022-10-04T14:02:07-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8154"},{"text":"%md\n\n## Casteo los bigints","user":"u632820","dateUpdated":"2022-10-04T14:01:31-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>Casteo los bigints</h2>\n</div>"}]},"apps":[],"jobName":"paragraph_1664902869740_-1637551882","id":"20221004-140109_1172805706","dateCreated":"2022-10-04T14:01:09-0300","dateStarted":"2022-10-04T14:01:20-0300","dateFinished":"2022-10-04T14:01:20-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8155"},{"text":"%livy.pyspark\n\n# CARGO ABT PRODUCTIVA \n\nabt_df= spark.sql(f\"\"\"\nSELECT \nid_suscripcion, origin, sum_kb_down_weekend_m0, avg_zt_cli_viv_u6m, tend_zt_cli_viv_m6, avg_rxpower_up_madrugada_m0, avg_zt_tm_u6m, sum_kb_up_noche_m0, prod_catv_antiq, avg_tot_tipo_prod_catv_totales_danio_u6m, prod_cm_sum_days_danio_cerrado_m0, ranking_gam, tend_kb_down_total_m6, antiq_cm_zt_m0, antiq_enabled_dignet_zt_m0, prod_cm_antiq, antiq_enabled_serv_zt_m0, avg_zt_cli_kms_u3m, compgte_prop_weekend_kb_up_m1, avg_tot_tipo_prod_cm_cerrado_danio_u6m, antiguedad_cliente, flg_flex, flg_digital,   \n error_baja_monto_prodcatv_bin, error_factura_monto_prodcatv_bin, error_promo_monto_prodcatv_bin, error_instalac_monto_prodcatv_bin, dias_sserv_monto_prodcatv_bin, otro_monto_prodcatv_bin, \n\n    \n    sexo_encoded, flg_converge_cv, flg_converge_tp, f_arnet, f_club_personal_ok, f_personal_video_ok, f_pospago, f_prepago, cobre, claro, movi, telecentro, gigared, supercanal, express, locales, sum_tot_importe_arpu_bin_m0, sum_tot_core_arpu_bin_m0, sum_tot_promos_arpu_bin_m0, sum_tot_desc_mult_arpu_bin_m0, sum_factura_monto_bruto_m0_bin_m0, sum_factura_monto_neto_m0_bin_m0, sum_factura_monto_descontado_m0_bin_m0, sum_factura_monto_bonif_m0_bin_m0, sum_factura_monto_bruto_m1_bin_m0, sum_factura_monto_neto_m1_bin_m0, sum_factura_monto_descontado_m1_bin_m0, diff_factura_monto_neto_m1_bin_m0, diff_factura_monto_bruto_m1_bin_m0, diff_factura_monto_descontado_m1_bin_m0, sum_tot_importe_bin, sum_tot_importe_cobrador_bin, sum_tot_importe_electronico_bin, sum_tot_importe_sucursal_bin, sum_tot_importe_uruguay_bin, sum_tot_importe_ventanilla_bin, sum_tot_importe_debito_bin, diff_tot_importe_bin_m1, diff_tot_importe_bin_m3, diff_tot_importe_bin_m6, diff_tot_importe_cobrador_bin_m1, diff_tot_importe_cobrador_bin_m3, diff_tot_importe_cobrador_bin_m6, diff_tot_importe_electronico_bin_m1, diff_tot_importe_electronico_bin_m3, diff_tot_importe_electronico_bin_m6, diff_tot_importe_sucursal_bin_m1, diff_tot_importe_sucursal_bin_m3, diff_tot_importe_sucursal_bin_m6, diff_tot_importe_uruguay_bin_m1, diff_tot_importe_uruguay_bin_m3, diff_tot_importe_uruguay_bin_m6, diff_tot_importe_ventanilla_bin_m1, diff_tot_importe_ventanilla_bin_m3, diff_tot_importe_ventanilla_bin_m6, diff_tot_importe_debito_bin_m1, diff_tot_importe_debito_bin_m3, diff_tot_importe_debito_bin_m6, antic_mora_0_30_t_ohe_m0, antic_mora_30_60_t_ohe_m0, antic_mora_60_90_t_ohe_m0, antic_mora_90_120_t_ohe_m0, antic_mora_m120_t_ohe_m0,   \n\ncast(     provincia_encoded  as int) as     provincia_encoded  , \ncast(     provincia_subregion_encoded  as int) as     provincia_subregion_encoded  , \ncast(     metodo_pago_encoded  as int) as     metodo_pago_encoded  , \ncast(     tipo_residencia_encoded  as int) as     tipo_residencia_encoded  , \ncast(     cat_str_hard_mid_user_ohe  as int) as     cat_str_hard_mid_user_ohe  , \ncast(     cat_str_heavy_user_ohe  as int) as     cat_str_heavy_user_ohe  , \ncast(     cat_str_low_mid_user_ohe  as int) as     cat_str_low_mid_user_ohe  , \ncast(     cat_str_low_user_ohe  as int) as     cat_str_low_user_ohe  , \ncast(     cat_str_mid_user_ohe  as int) as     cat_str_mid_user_ohe  , \ncast(     cat_gam_null_ohe  as int) as     cat_gam_null_ohe  , \ncast(     cat_gam_full_user_ohe  as int) as     cat_gam_full_user_ohe  , \ncast(     cat_gam_hard_mid_user_ohe  as int) as     cat_gam_hard_mid_user_ohe  , \ncast(     cat_gam_heavy_user_ohe  as int) as     cat_gam_heavy_user_ohe  , \ncast(     cat_gam_low_mid_user_ohe  as int) as     cat_gam_low_mid_user_ohe  , \ncast(     cat_gam_low_user_ohe  as int) as     cat_gam_low_user_ohe  , \ncast(     cat_gam_mid_user_ohe  as int) as     cat_gam_mid_user_ohe  , \ncast(     cat_rrss_null_ohe  as int) as     cat_rrss_null_ohe  , \ncast(     cat_rrss_full_user_ohe  as int) as     cat_rrss_full_user_ohe  , \ncast(     cat_rrss_hard_mid_user_ohe  as int) as     cat_rrss_hard_mid_user_ohe  , \ncast(     cat_rrss_heavy_user_ohe  as int) as     cat_rrss_heavy_user_ohe  , \ncast(     cat_rrss_low_mid_user_ohe  as int) as     cat_rrss_low_mid_user_ohe  , \ncast(     cat_rrss_low_user_ohe  as int) as     cat_rrss_low_user_ohe  , \ncast(     cat_rrss_mid_user_ohe  as int) as     cat_rrss_mid_user_ohe  , \ncast(     error_baja_monto_prodcm_bin  as int) as     error_baja_monto_prodcm_bin  , \ncast(     error_factura_monto_prodcm_bin  as int) as     error_factura_monto_prodcm_bin  , \ncast(     error_promo_monto_prodcm_bin  as int) as     error_promo_monto_prodcm_bin  , \ncast(     error_instalac_monto_prodcm_bin  as int) as     error_instalac_monto_prodcm_bin  , \ncast(     dias_sserv_monto_prodcm_bin  as int) as     dias_sserv_monto_prodcm_bin  , \ncast(     otro_monto_prodcm_bin  as int) as     otro_monto_prodcm_bin  , \n\ncast(cat_str_null_ohe as int) as cat_str_null_ohe, \ncast(cat_str_full_user_ohe as int) as cat_str_full_user_ohe,\n\ncast( intencion_baja_catv_m0 as int) as intencion_baja_catv_m0 , \ncast( intencion_baja_premium_m0 as int) as intencion_baja_premium_m0 , \ncast( intencion_baja_catvpremium_m0 as int) as intencion_baja_catvpremium_m0 , \ncast( mudanza_catv_m0 as int) as mudanza_catv_m0 , \ncast( ret_catv_m0 as int) as ret_catv_m0 , \ncast( ret_premium_m0 as int) as ret_premium_m0 , \ncast( ret_catvpremium_m0 as int) as ret_catvpremium_m0 , \ncast( mora_catv_m0 as int) as mora_catv_m0 , \ncast( mora_premium_m0 as int) as mora_premium_m0 , \ncast( mora_catvpremium_m0 as int) as mora_catvpremium_m0 , \ncast( upgrade_cm_m0 as int) as upgrade_cm_m0 , \ncast( downgrade_cm_m0 as int) as downgrade_cm_m0 , \ncast( intencion_baja_cm_m0 as int) as intencion_baja_cm_m0 , \ncast( mudanza_cm_m0 as int) as mudanza_cm_m0 , \ncast( ret_cm_m0 as int) as ret_cm_m0 , \ncast( mora_cm_m0 as int) as mora_cm_m0 , \n\n    provincia_zona, flag_cumsum_intencion_baja_catv_u6m, flag_sum_tot_tipo_prod_catv_totales_danio_m0, flag_prod_catv_sum_days_danio_cerrado_m0, flag_prod_catv_sum_days_danio_abierto_m0, flag_sum_acum_tot_tipo_prod_catv_totales_danio_u6m, flag_num_promos_vigentes_prod_all_nomain_m0, flag_num_promos_fide_prod_all_main_m0, flag_numacum_promos_fide_prod_all_main_u6m, flag_num_days_fin_promo_prod_all_main_m0, flag_sum_days_paid_delay_m0, flag_sum_importe_saldo_antiq_m0, flag_sumacum_interact_gestiones_especiales_u6m, flag_sumacum_interact_fija_u6m, flag_cumsum_upgrade_cm_u6m, flag_sum_tot_tipo_prod_cm_abierto_danio_m0, flag_sum_tot_tipo_prod_cm_cerrado_danio_m0, flag_sum_tot_tipo_prod_cm_infundado_danio_m0, flag_prod_cm_sum_days_danio_cerrado_m0, flag_prod_cm_sum_days_danio_abierto_m0, flag_sum_acum_tot_tipo_prod_cm_abierto_danio_u6m, flag_sum_acum_tot_tipo_prod_cm_cerrado_danio_u6m, flag_sum_acum_tot_tipo_prod_cm_infundado_danio_u6m, flag_sum_acum_tot_tipo_prod_catv_Abierto_danio_u6m, periodo\nFROM sdb_datamining.tempna_abtimputadaCATVHD2_m\nWHERE periodo in {PERIODO_TRAIN1, PERIODO_TRAIN2, PERIODO_TRAIN3, PERIODO_TRAIN4, PERIODO_TRAIN5, PERIODO_TRAIN6}\n\"\"\"\n)","user":"u632820","dateUpdated":"2022-09-30T16:12:59-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_100111<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_100111/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_100111/</a>"}]},"apps":[],"jobName":"paragraph_1664299294347_2012740451","id":"20220819-100906_1830911214","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-09-27T22:55:08-0300","dateFinished":"2022-09-27T22:55:09-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8156"},{"text":"%livy.pyspark\nabt_df = abt_df.fillna(0, subset=numericas)\nabt_df = abt_df.fillna(9999, subset=categoricas+flags)","user":"u632820","dateUpdated":"2022-09-30T16:12:59-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"ERROR","msg":[{"type":"TEXT","data":"name 'abt_df' is not defined\nTraceback (most recent call last):\nNameError: name 'abt_df' is not defined\n"}]},"apps":[],"jobName":"paragraph_1664299294349_1411136468","id":"20220819-100910_219983756","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-09-29T16:42:10-0300","dateFinished":"2022-09-29T16:42:11-0300","status":"ERROR","progressUpdateIntervalMs":500,"$$hashKey":"object:8157"},{"text":"%livy.pyspark\n# CARGO LAS ETIQUETAS CORRESPONDIENTES A LOS PERIODOS DE TRAIN\n\nlabel_df = spark.sql(f\"\"\"\nSELECT \nperiodo, \nid_suscripcion,\nCASE WHEN (target_churn_combocatvclassic + target_churn_combohd) > 0 THEN 1 ELSE 0 end As label\nFROM data_lake_analytics.stg_hogartargetschurn_m \nWHERE periodo in {PERIODO_TRAIN1, PERIODO_TRAIN2, PERIODO_TRAIN3, PERIODO_TRAIN4, PERIODO_TRAIN5, PERIODO_TRAIN6}\n\"\"\")","user":"u632820","dateUpdated":"2022-09-30T16:12:59-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_100111<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_100111/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_100111/</a>"}]},"apps":[],"jobName":"paragraph_1664299294351_-200807954","id":"20220819-100924_384444281","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-09-27T22:55:16-0300","dateFinished":"2022-09-27T22:55:17-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8158"},{"text":"%livy.pyspark\n\ntrain_df = abt_df.join(label_df, ['id_suscripcion', 'periodo'], 'inner') # se hace join con inner para dejar fuera aquellos casos que no tienen target","user":"u632820","dateUpdated":"2022-09-30T16:12:59-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_100111<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_100111/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_100111/</a>"}]},"apps":[],"jobName":"paragraph_1664299294353_1711714584","id":"20220819-100924_1799597251","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-09-27T22:55:59-0300","dateFinished":"2022-09-27T22:56:00-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8159"},{"text":"%livy.pyspark\nprint(\"TRAIN Shape: \" , train_df.count(), len(train_df.columns))\n\nmajor_df = train_df.filter(F.col(TARGET) == 0)\nminor_df = train_df.filter(F.col(TARGET) == 1)\nratio = int(major_df.count()/minor_df.count())\nprint(\"ratio: {}\".format(ratio))\n\nsampled_majority_df = major_df.sample(False, 20/ratio, seed=SEED)\ntrain_undersampled_df = sampled_majority_df.unionAll(minor_df)\n\n","user":"u632820","dateUpdated":"2022-09-30T16:12:59-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"TRAIN Shape:  7954536 165\nratio: 93"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_100111<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_100111/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_100111/</a>"}]},"apps":[],"jobName":"paragraph_1664299294355_-1947234114","id":"20220819-100924_645020242","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-09-27T22:56:03-0300","dateFinished":"2022-09-27T22:59:22-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8160"},{"text":"%livy.pyspark\n\nprint(\"TRAIN Shape: \" , train_undersampled_df.count(), len(train_undersampled_df.columns))\n\n# 1.777.727\n","user":"u632820","dateUpdated":"2022-09-30T16:12:59-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"ERROR","msg":[{"type":"TEXT","data":"Job is cancelled"}]},"apps":[],"jobName":"paragraph_1664307837606_665279144","id":"20220927-164357_1277371350","dateCreated":"2022-09-27T16:43:57-0300","dateStarted":"2022-09-27T22:57:28-0300","dateFinished":"2022-09-27T23:00:48-0300","status":"ABORT","progressUpdateIntervalMs":500,"$$hashKey":"object:8161"},{"text":"%livy.pyspark\n\n\n# Grabo el universo + Target, de 7M paso a 1.7M\n\ntrain_undersampled_df.write.mode('overwrite').format('parquet').saveAsTable('sdb_datamining.tempna_abtimputadaCATVHD2_m_seba')\ntrain_undersampled_df.unpersist","user":"u632820","dateUpdated":"2022-10-04T13:51:34-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_100111<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_100111/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_100111/</a>"}]},"apps":[],"jobName":"paragraph_1664322850395_-201395995","id":"20220927-205410_1467890862","dateCreated":"2022-09-27T20:54:10-0300","dateStarted":"2022-09-27T21:32:28-0300","dateFinished":"2022-09-27T21:37:13-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8162"},{"text":"%md\n\n# Leo la tabla que grabe con el target balanceado","user":"u632820","dateUpdated":"2022-10-04T13:54:49-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Leo la tabla que grabe con el target balanceado</h1>\n</div>"}]},"apps":[],"jobName":"paragraph_1664480539920_851811356","id":"20220929-164219_1556417412","dateCreated":"2022-09-29T16:42:19-0300","dateStarted":"2022-10-04T13:54:38-0300","dateFinished":"2022-10-04T13:54:38-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8163"},{"text":"%livy.pyspark\n\ntrain_undersampled_df= spark.sql(\" select * from sdb_datamining.tempna_abtimputadaCATVHD2_m_seba\")","user":"u632820","dateUpdated":"2022-10-05T16:22:35-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664322953570_-1047532184","id":"20220927-205553_690414765","dateCreated":"2022-09-27T20:55:53-0300","dateStarted":"2022-10-05T16:22:35-0300","dateFinished":"2022-10-05T16:22:43-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8164"},{"text":"%livy.pyspark\n\nprint(\"Number of partitions PARTY: {}\".format(train_undersampled_df.rdd.getNumPartitions()))\n\ntrain_undersampled_df = train_undersampled_df.coalesce(40)\n\nprint(\"Number of partitions PARTY: {}\".format(train_undersampled_df.rdd.getNumPartitions()))\n\n# 1 task 1 core 1 exc\n","user":"u632820","dateUpdated":"2022-10-05T16:22:51-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Number of partitions PARTY: 77\nNumber of partitions PARTY: 40"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664473644660_986434059","id":"20220929-144724_2004159241","dateCreated":"2022-09-29T14:47:24-0300","dateStarted":"2022-10-05T16:22:51-0300","dateFinished":"2022-10-05T16:22:52-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8165"},{"text":"%livy.pyspark\nprint(train_undersampled_df.count())","user":"u632820","dateUpdated":"2022-10-05T16:23:07-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"1777639"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664323013566_-372684209","id":"20220927-205653_777879477","dateCreated":"2022-09-27T20:56:53-0300","dateStarted":"2022-10-05T16:23:07-0300","dateFinished":"2022-10-05T16:23:37-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8166"},{"text":"%md\n\n# Saco Columnas Correlacionadas\n","user":"u632820","dateUpdated":"2022-10-04T13:58:56-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Saco Columnas Correlacionadas</h1>\n</div>"}]},"apps":[],"jobName":"paragraph_1664902711521_-674771191","id":"20221004-135831_1778058756","dateCreated":"2022-10-04T13:58:31-0300","dateStarted":"2022-10-04T13:58:45-0300","dateFinished":"2022-10-04T13:58:45-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8167"},{"text":"%livy.pyspark\n\n# Numerical vars\nnumericCols = [c for c in train_undersampled_df.columns if c not in ['id_suscripcion','periodo', 'origin',TARGET]]\n\nprint(\"Num. numeric vars: \" , len(numericCols))","user":"u632820","dateUpdated":"2022-09-30T16:13:00-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Num. numeric vars:  161"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_126103<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/</a>"}]},"apps":[],"jobName":"paragraph_1664299294358_-1253771376","id":"20220819-100924_1851690285","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-09-30T12:43:37-0300","dateFinished":"2022-09-30T12:43:38-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8168"},{"text":"%livy.pyspark\n\n# Saco correlaciones con un 10% de la base en Pandas, :(\n\nimport numpy as np\n\ndf = train_undersampled_df.sample(fraction=0.1, seed=SEED).toPandas()\n\n# Create correlation matrix\ncorr_matrix = df.corr().abs()\n\n# Select upper triangle of correlation matrix\nupper = corr_matrix.where(np.triu(np.ones(corr_matrix.shape), k=1).astype(np.bool))\n\n# Find features with correlation greater than 0.95\nto_drop = [column for column in upper.columns if any(upper[column] > 0.95)]\n\n# Drop features \nto_drop\n# df.drop(to_drop, axis=1, inplace=True)\n","user":"u632820","dateUpdated":"2022-10-04T13:51:58-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"['error_factura_monto_prodcatv_bin', 'error_promo_monto_prodcatv_bin', 'error_instalac_monto_prodcatv_bin', 'dias_sserv_monto_prodcatv_bin', 'otro_monto_prodcatv_bin', 'flg_converge_cv', 'flg_converge_tp', 'f_arnet', 'f_club_personal_ok', 'f_personal_video_ok', 'f_pospago', 'f_prepago', 'claro', 'movi', 'telecentro', 'gigared', 'supercanal', 'express', 'locales', 'sum_tot_core_arpu_bin_m0', 'sum_tot_promos_arpu_bin_m0', 'sum_tot_desc_mult_arpu_bin_m0', 'sum_factura_monto_bruto_m0_bin_m0', 'sum_factura_monto_neto_m0_bin_m0', 'sum_factura_monto_descontado_m0_bin_m0', 'sum_factura_monto_bonif_m0_bin_m0', 'sum_factura_monto_neto_m1_bin_m0', 'sum_factura_monto_descontado_m1_bin_m0', 'diff_factura_monto_neto_m1_bin_m0', 'diff_factura_monto_bruto_m1_bin_m0', 'diff_factura_monto_descontado_m1_bin_m0', 'sum_tot_importe_cobrador_bin', 'sum_tot_importe_electronico_bin', 'sum_tot_importe_sucursal_bin', 'sum_tot_importe_uruguay_bin', 'sum_tot_importe_ventanilla_bin', 'sum_tot_importe_debito_bin', 'diff_tot_importe_bin_m1', 'diff_tot_importe_bin_m3', 'diff_tot_importe_bin_m6', 'diff_tot_importe_cobrador_bin_m1', 'diff_tot_importe_cobrador_bin_m3', 'diff_tot_importe_cobrador_bin_m6', 'diff_tot_importe_electronico_bin_m1', 'diff_tot_importe_electronico_bin_m3', 'diff_tot_importe_electronico_bin_m6', 'diff_tot_importe_sucursal_bin_m1', 'diff_tot_importe_sucursal_bin_m3', 'diff_tot_importe_sucursal_bin_m6', 'diff_tot_importe_uruguay_bin_m1', 'diff_tot_importe_uruguay_bin_m3', 'diff_tot_importe_uruguay_bin_m6', 'diff_tot_importe_ventanilla_bin_m1', 'diff_tot_importe_ventanilla_bin_m3', 'diff_tot_importe_ventanilla_bin_m6', 'diff_tot_importe_debito_bin_m1', 'diff_tot_importe_debito_bin_m3', 'diff_tot_importe_debito_bin_m6', 'antic_mora_30_60_t_ohe_m0', 'antic_mora_60_90_t_ohe_m0', 'antic_mora_90_120_t_ohe_m0', 'antic_mora_m120_t_ohe_m0', 'provincia_encoded', 'provincia_subregion_encoded', 'metodo_pago_encoded', 'tipo_residencia_encoded', 'cat_str_heavy_user_ohe', 'cat_str_low_mid_user_ohe', 'cat_str_low_user_ohe', 'cat_str_mid_user_ohe', 'cat_gam_null_ohe', 'cat_gam_full_user_ohe', 'cat_gam_hard_mid_user_ohe', 'cat_gam_heavy_user_ohe', 'cat_gam_low_mid_user_ohe', 'cat_gam_low_user_ohe', 'cat_gam_mid_user_ohe', 'cat_rrss_null_ohe', 'cat_rrss_full_user_ohe', 'cat_rrss_hard_mid_user_ohe', 'cat_rrss_heavy_user_ohe', 'cat_rrss_low_mid_user_ohe', 'cat_rrss_low_user_ohe', 'cat_rrss_mid_user_ohe', 'error_baja_monto_prodcm_bin', 'error_factura_monto_prodcm_bin', 'error_promo_monto_prodcm_bin', 'error_instalac_monto_prodcm_bin', 'dias_sserv_monto_prodcm_bin', 'otro_monto_prodcm_bin', 'cat_str_null_ohe', 'cat_str_full_user_ohe', 'intencion_baja_premium_m0', 'intencion_baja_catvpremium_m0', 'mudanza_catv_m0', 'ret_catv_m0', 'ret_premium_m0', 'ret_catvpremium_m0', 'mora_catv_m0', 'mora_premium_m0', 'mora_catvpremium_m0', 'flag_sum_acum_tot_tipo_prod_catv_totales_danio_u6m', 'flag_sum_importe_saldo_antiq_m0', 'flag_prod_cm_sum_days_danio_abierto_m0']"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_126103<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/</a>"}]},"apps":[],"jobName":"paragraph_1664553616843_1022431173","id":"20220930-130016_1041524048","dateCreated":"2022-09-30T13:00:16-0300","dateStarted":"2022-09-30T13:01:46-0300","dateFinished":"2022-09-30T13:04:41-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8169"},{"text":"%livy.pyspark\n\nprint(len(to_drop))\n\ntrain_undersampled_df = train_undersampled_df.drop(*to_drop)\n\nprint(len(train_undersampled_df.columns))","user":"u632820","dateUpdated":"2022-09-30T16:13:00-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"104\n['id_suscripcion', 'periodo', 'origin', 'sum_kb_down_weekend_m0', 'avg_zt_cli_viv_u6m', 'tend_zt_cli_viv_m6', 'avg_rxpower_up_madrugada_m0', 'avg_zt_tm_u6m', 'sum_kb_up_noche_m0', 'prod_catv_antiq', 'avg_tot_tipo_prod_catv_totales_danio_u6m', 'prod_cm_sum_days_danio_cerrado_m0', 'ranking_gam', 'tend_kb_down_total_m6', 'antiq_cm_zt_m0', 'antiq_enabled_dignet_zt_m0', 'prod_cm_antiq', 'antiq_enabled_serv_zt_m0', 'avg_zt_cli_kms_u3m', 'compgte_prop_weekend_kb_up_m1', 'avg_tot_tipo_prod_cm_cerrado_danio_u6m', 'antiguedad_cliente', 'flg_flex', 'flg_digital', 'error_baja_monto_prodcatv_bin', 'sexo_encoded', 'cobre', 'sum_tot_importe_arpu_bin_m0', 'sum_factura_monto_bruto_m1_bin_m0', 'sum_tot_importe_bin', 'antic_mora_0_30_t_ohe_m0', 'cat_str_hard_mid_user_ohe', 'intencion_baja_catv_m0', 'upgrade_cm_m0', 'downgrade_cm_m0', 'intencion_baja_cm_m0', 'mudanza_cm_m0', 'ret_cm_m0', 'mora_cm_m0', 'provincia_zona', 'flag_cumsum_intencion_baja_catv_u6m', 'flag_sum_tot_tipo_prod_catv_totales_danio_m0', 'flag_prod_catv_sum_days_danio_cerrado_m0', 'flag_prod_catv_sum_days_danio_abierto_m0', 'flag_num_promos_vigentes_prod_all_nomain_m0', 'flag_num_promos_fide_prod_all_main_m0', 'flag_numacum_promos_fide_prod_all_main_u6m', 'flag_num_days_fin_promo_prod_all_main_m0', 'flag_sum_days_paid_delay_m0', 'flag_sumacum_interact_gestiones_especiales_u6m', 'flag_sumacum_interact_fija_u6m', 'flag_cumsum_upgrade_cm_u6m', 'flag_sum_tot_tipo_prod_cm_abierto_danio_m0', 'flag_sum_tot_tipo_prod_cm_cerrado_danio_m0', 'flag_sum_tot_tipo_prod_cm_infundado_danio_m0', 'flag_prod_cm_sum_days_danio_cerrado_m0', 'flag_sum_acum_tot_tipo_prod_cm_abierto_danio_u6m', 'flag_sum_acum_tot_tipo_prod_cm_cerrado_danio_u6m', 'flag_sum_acum_tot_tipo_prod_cm_infundado_danio_u6m', 'flag_sum_acum_tot_tipo_prod_catv_Abierto_danio_u6m', 'label']"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_126103<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/</a>"}]},"apps":[],"jobName":"paragraph_1664552465651_-1961233428","id":"20220930-124105_750739448","dateCreated":"2022-09-30T12:41:05-0300","dateStarted":"2022-09-30T13:05:51-0300","dateFinished":"2022-09-30T13:05:52-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8170"},{"text":"%livy.pyspark\nprint(len(train_undersampled_df.columns))","user":"u632820","dateUpdated":"2022-09-30T16:13:00-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"61"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_126103<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/</a>"}]},"apps":[],"jobName":"paragraph_1664553971636_-3476433","id":"20220930-130611_952959021","dateCreated":"2022-09-30T13:06:11-0300","dateStarted":"2022-09-30T13:06:12-0300","dateFinished":"2022-09-30T13:06:13-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8171"},{"text":"%livy.pyspark\n\n# Grabo la base con las columnas que no estan correlacionadas\n\ntrain_undersampled_df.write.mode('overwrite').format('parquet').saveAsTable('sdb_datamining.tempna_abtimputadaCATVHD2_m_seba_sinCorr')\n\ntrain_undersampled_df.unpersist","user":"u632820","dateUpdated":"2022-10-04T13:52:20-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"<bound method DataFrame.unpersist of DataFrame[id_suscripcion: bigint, periodo: int, origin: string, sum_kb_down_weekend_m0: double, avg_zt_cli_viv_u6m: double, tend_zt_cli_viv_m6: double, avg_rxpower_up_madrugada_m0: double, avg_zt_tm_u6m: double, sum_kb_up_noche_m0: double, prod_catv_antiq: int, avg_tot_tipo_prod_catv_totales_danio_u6m: double, prod_cm_sum_days_danio_cerrado_m0: double, ranking_gam: double, tend_kb_down_total_m6: double, antiq_cm_zt_m0: double, antiq_enabled_dignet_zt_m0: double, prod_cm_antiq: int, antiq_enabled_serv_zt_m0: double, avg_zt_cli_kms_u3m: double, compgte_prop_weekend_kb_up_m1: decimal(11,1), avg_tot_tipo_prod_cm_cerrado_danio_u6m: double, antiguedad_cliente: double, flg_flex: int, flg_digital: int, error_baja_monto_prodcatv_bin: double, sexo_encoded: int, cobre: int, sum_tot_importe_arpu_bin_m0: double, sum_factura_monto_bruto_m1_bin_m0: double, sum_tot_importe_bin: double, antic_mora_0_30_t_ohe_m0: int, cat_str_hard_mid_user_ohe: int, intencion_baja_catv_m0: int, upgrade_cm_m0: int, downgrade_cm_m0: int, intencion_baja_cm_m0: int, mudanza_cm_m0: int, ret_cm_m0: int, mora_cm_m0: int, provincia_zona: int, flag_cumsum_intencion_baja_catv_u6m: int, flag_sum_tot_tipo_prod_catv_totales_danio_m0: int, flag_prod_catv_sum_days_danio_cerrado_m0: int, flag_prod_catv_sum_days_danio_abierto_m0: int, flag_num_promos_vigentes_prod_all_nomain_m0: int, flag_num_promos_fide_prod_all_main_m0: int, flag_numacum_promos_fide_prod_all_main_u6m: int, flag_num_days_fin_promo_prod_all_main_m0: int, flag_sum_days_paid_delay_m0: int, flag_sumacum_interact_gestiones_especiales_u6m: int, flag_sumacum_interact_fija_u6m: int, flag_cumsum_upgrade_cm_u6m: int, flag_sum_tot_tipo_prod_cm_abierto_danio_m0: int, flag_sum_tot_tipo_prod_cm_cerrado_danio_m0: int, flag_sum_tot_tipo_prod_cm_infundado_danio_m0: int, flag_prod_cm_sum_days_danio_cerrado_m0: int, flag_sum_acum_tot_tipo_prod_cm_abierto_danio_u6m: int, flag_sum_acum_tot_tipo_prod_cm_cerrado_danio_u6m: int, flag_sum_acum_tot_tipo_prod_cm_infundado_danio_u6m: int, flag_sum_acum_tot_tipo_prod_catv_Abierto_danio_u6m: int, label: int]>"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_126103<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/</a>"}]},"apps":[],"jobName":"paragraph_1664540341951_-1174711067","id":"20220930-091901_364378952","dateCreated":"2022-09-30T09:19:01-0300","dateStarted":"2022-09-30T13:06:18-0300","dateFinished":"2022-09-30T13:06:32-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8172"},{"text":"%md\n\n# Leo la tabla que grabe\n","user":"u632820","dateUpdated":"2022-10-04T13:54:11-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","editorHide":false,"tableHide":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Leo la tabla que grabe</h1>\n</div>"}]},"apps":[],"jobName":"paragraph_1664808595623_1544310980","id":"20221003-114955_1460850652","dateCreated":"2022-10-03T11:49:55-0300","dateStarted":"2022-10-04T13:52:37-0300","dateFinished":"2022-10-04T13:52:37-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8173"},{"text":"%livy.pyspark\n\ntrain_undersampled_df= spark.sql(\" select * from sdb_datamining.tempna_abtimputadaCATVHD2_m_seba_sinCorr\")\n\nprint(\"Number of partitions PARTY: {}\".format(train_undersampled_df.rdd.getNumPartitions()))\ntrain_undersampled_df = train_undersampled_df.coalesce(5)\nprint(\"Number of partitions PARTY: {}\".format(train_undersampled_df.rdd.getNumPartitions()))","user":"u632820","dateUpdated":"2022-10-05T16:27:06-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Number of partitions PARTY: 8\nNumber of partitions PARTY: 5"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664540353783_997678802","id":"20220930-091913_854713224","dateCreated":"2022-09-30T09:19:13-0300","dateStarted":"2022-10-05T16:27:06-0300","dateFinished":"2022-10-05T16:27:07-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8174"},{"text":"%livy.pyspark\nimport pyspark.sql.functions as F\n\n# Las particiones tienen que ser parejas...\n\ntrain_undersampled_df.groupBy(F.spark_partition_id()).count().show()\n\n# https://towardsdatascience.com/data-skew-in-pyspark-783d529a9dd7\n","user":"u632820","dateUpdated":"2022-10-05T16:27:12-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+------+\n|SPARK_PARTITION_ID()| count|\n+--------------------+------+\n|                   1|370897|\n|                   3|227913|\n|                   4|410905|\n|                   2|273295|\n|                   0|494629|\n+--------------------+------+"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664565544439_39661138","id":"20220930-161904_63890688","dateCreated":"2022-09-30T16:19:04-0300","dateStarted":"2022-10-05T16:27:12-0300","dateFinished":"2022-10-05T16:28:16-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8175"},{"text":"%livy.pyspark\n\n# Numerical vars\nnumericCols = [c for c in train_undersampled_df.columns if c not in ['id_suscripcion','periodo', 'origin',TARGET]]\n\nprint(\"Num. numeric vars: \" , len(numericCols))","user":"u632820","dateUpdated":"2022-10-05T16:27:19-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Num. numeric vars:  57"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664480271289_1156588138","id":"20220929-163751_1663781830","dateCreated":"2022-09-29T16:37:51-0300","dateStarted":"2022-10-05T16:27:19-0300","dateFinished":"2022-10-05T16:28:17-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8176"},{"text":"%livy.pyspark\n\n#separo Train y Test\n\n(trainingData, testData) = train_undersampled_df.randomSplit([0.7, 0.3], seed=1234)\n\nprint(\"TRAIN Shape: \" , trainingData.count())","user":"u632820","dateUpdated":"2022-10-05T16:27:23-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"TRAIN Shape:  1244660"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664302283499_-1076877474","id":"20220927-151123_1550407536","dateCreated":"2022-09-27T15:11:23-0300","dateStarted":"2022-10-05T16:28:17-0300","dateFinished":"2022-10-05T16:28:31-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8177"},{"text":"%livy.pyspark\n\ntrainingData.groupBy(F.spark_partition_id()).count().show()","user":"u632820","dateUpdated":"2022-10-05T16:28:49-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+------+\n|SPARK_PARTITION_ID()| count|\n+--------------------+------+\n|                   1|259656|\n|                   3|159407|\n|                   4|287901|\n|                   2|190969|\n|                   0|346727|\n+--------------------+------+"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664998045192_-2111826246","id":"20221005-162725_1191497902","dateCreated":"2022-10-05T16:27:25-0300","dateStarted":"2022-10-05T16:28:49-0300","dateFinished":"2022-10-05T16:29:00-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8178"},{"text":"%livy.pyspark\n\n# Target\ntarget_st = StringIndexer(inputCol=TARGET, outputCol='label_')\n\n# Variables\nassembler = VectorAssembler(inputCols=numericCols, outputCol=\"features\")\n\n#scaler = StandardScaler(inputCol='features', outputCol='features_scaled', withStd=True. withMean=False)","user":"u632820","dateUpdated":"2022-10-05T16:29:22-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664299294360_1951200445","id":"20220819-100923_1003402545","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-10-05T16:29:23-0300","dateFinished":"2022-10-05T16:29:24-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8179"},{"text":"%md\n## Entrenamos un RF #1\n","user":"u632820","dateUpdated":"2022-10-04T14:02:56-0300","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>Entrenamos un RF #1</h2>\n</div>"}]},"apps":[],"jobName":"paragraph_1664299294368_-497342125","id":"20220819-101309_697675393","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-10-04T14:02:29-0300","dateFinished":"2022-10-04T14:02:29-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8180"},{"text":"%livy.pyspark\n# Entrenamos un modelo usando cross validation y probando con diferentes hiperparametros para obtener un modelo de challenger que supere al modelo productivo\n# Se probaron hiperparametrizaciones con 150, 200 y 300 árboles. entre 150 y 200 no hay cambios, si mejora medio punto con 300 árboles - 2da prueba 300 y 400 árboles\n# en cuanto a la profundidad de 5 a 10 capas mejora pero a partir de 10 ya comienza a dar idea de overfiting - Se deja fijo en 10 \n\nmodel = RandomForestClassifier(labelCol=\"label_\", featuresCol=\"features\")\n\nevaluator=BinaryClassificationEvaluator()\n\nparamGrid = ParamGridBuilder() \\\n    .addGrid(model.numTrees, [100]) \\\n    .addGrid(model.maxDepth, [20]) \\\n    .addGrid(model.maxBins, [32]) \\\n    .build()\n\n    \ncrossval2 = CrossValidator(estimator=model,\n                          estimatorParamMaps=paramGrid,\n                          evaluator=evaluator,\n                          numFolds=3)  # use 3+ folds in practice\n\nstages = [target_st, assembler,  crossval2 ]\n\npipeline = Pipeline(stages=stages)\n\n# Run cross-validation, and choose the best set of parameters.\ncvModel2 = pipeline.fit(trainingData)","user":"u632820","dateUpdated":"2022-10-04T11:25:58-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_162967<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/</a>"}]},"apps":[],"jobName":"paragraph_1664299294370_164199550","id":"20220824-093835_1894163614","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-10-04T11:25:58-0300","dateFinished":"2022-10-04T13:02:20-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8181"},{"text":"%livy.pyspark\ntestDataScore.count()","user":"u632820","dateUpdated":"2022-09-30T16:13:00-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"533601"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_126103<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/</a>"}]},"apps":[],"jobName":"paragraph_1664558118587_-1418082515","id":"20220930-141518_165002574","dateCreated":"2022-09-30T14:15:18-0300","dateStarted":"2022-09-30T14:15:23-0300","dateFinished":"2022-09-30T14:15:33-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8182"},{"text":"%livy.pyspark\n\n\n\n\"\"\"\nSin Scaler\n\nmodel = RandomForestClassifier(labelCol='label', featuresCol=\"features\")\n\nstages = [target_st, assembler,  crossval2 ]\n\n\"\"\"\n\n\n\"\"\"\nCon Scaler\n\nmodel = RandomForestClassifier(labelCol='label', featuresCol=\"features_scaled\")\n\nstages = [target_st, assembler, scaler, crossval2 ]\n\n\"\"\"\n\n\n# Run the stages as a Pipeline. This puts the data through all of the feature transformations we described in a single call.\n# Entreno el modelo \n\ntestDataScore = cvModel2.transform(testData)\nevaluator.evaluate(testDataScore)\n\n# El mejor modelo entrenado\nbestModel = cvModel2.stages[-1].bestModel\nprint(bestModel.extractParamMap())\n\nprint('--------------------------')\n\nprint(\"Test Area Under ROC: \" + str(evaluator.evaluate(testDataScore, {evaluator.metricName: \"areaUnderROC\"})))\n#https://towardsdatascience.com/machine-learning-with-pyspark-and-mllib-solving-a-binary-classification-problem-96396065d2aa\n\nprint('--------------------------')\n\nimportances = bestModel.featureImportances\nidx = 0\nidx2 = 0\nfor i in importances:\n  idx += 1\n  if i > 0.001:\n    print(i, numericCols[idx])\n    idx2 += 1\nprint(idx2 +1)\n\n\n","user":"u632820","dateUpdated":"2022-10-04T11:26:10-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"{Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='cacheNodeIds', doc='If false, the algorithm will pass trees to executors to match instances with nodes. If true, the algorithm will cache node IDs for each instance. Caching can speed up training of deeper trees.'): False, Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='checkpointInterval', doc='set checkpoint interval (>= 1) or disable checkpoint (-1). E.g. 10 means that the cache will get checkpointed every 10 iterations. Note: this setting will be ignored if the checkpoint directory is not set in the SparkContext'): 10, Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='featureSubsetStrategy', doc='The number of features to consider for splits at each tree node. Supported options: auto, all, onethird, sqrt, log2, (0.0-1.0], [1-n].'): 'auto', Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='featuresCol', doc='features column name'): 'features', Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='impurity', doc='Criterion used for information gain calculation (case-insensitive). Supported options: entropy, gini'): 'gini', Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='labelCol', doc='label column name'): 'label_', Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='maxBins', doc='Max number of bins for discretizing continuous features.  Must be >=2 and >= number of categories for any categorical feature.'): 32, Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='maxDepth', doc='Maximum depth of the tree. (>= 0) E.g., depth 0 means 1 leaf node; depth 1 means 1 internal node + 2 leaf nodes.'): 20, Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='maxMemoryInMB', doc='Maximum memory in MB allocated to histogram aggregation.'): 256, Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='minInfoGain', doc='Minimum information gain for a split to be considered at a tree node.'): 0.0, Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='minInstancesPerNode', doc='Minimum number of instances each child must have after split.  If a split causes the left or right child to have fewer than minInstancesPerNode, the split will be discarded as invalid. Should be >= 1.'): 1, Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='numTrees', doc='Number of trees to train (>= 1)'): 100, Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='predictionCol', doc='prediction column name'): 'prediction', Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='probabilityCol', doc='Column name for predicted class conditional probabilities. Note: Not all models output well-calibrated probability estimates! These probabilities should be treated as confidences, not precise probabilities'): 'probability', Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='rawPredictionCol', doc='raw prediction (a.k.a. confidence) column name'): 'rawPrediction', Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='seed', doc='random seed'): -5387697053847413545, Param(parent='RandomForestClassifier_4e1da202e7633c94e415', name='subsamplingRate', doc='Fraction of the training data used for learning each decision tree, in range (0, 1].'): 1.0}\n--------------------------\nTest Area Under ROC: 0.7128553733938865\n--------------------------\n0.0645176592715014 avg_zt_cli_viv_u6m\n0.06205792542894339 tend_zt_cli_viv_m6\n0.05496797395789461 avg_rxpower_up_madrugada_m0\n0.054975828954287015 avg_zt_tm_u6m\n0.018093114349215286 sum_kb_up_noche_m0\n0.05182123896008827 prod_catv_antiq\n0.007833305124244625 avg_tot_tipo_prod_catv_totales_danio_u6m\n0.0018512405201822413 prod_cm_sum_days_danio_cerrado_m0\n0.0038301199840866085 ranking_gam\n0.035289627221896935 tend_kb_down_total_m6\n0.0548785065454607 antiq_cm_zt_m0\n0.04608642253911047 antiq_enabled_dignet_zt_m0\n0.041071905951435526 prod_cm_antiq\n0.006461202156115149 antiq_enabled_serv_zt_m0\n0.04874636417465398 avg_zt_cli_kms_u3m\n0.05777116773461459 compgte_prop_weekend_kb_up_m1\n0.013363221531826104 avg_tot_tipo_prod_cm_cerrado_danio_u6m\n0.002165728298460565 antiguedad_cliente\n0.0699553851571634 flg_flex\n0.0030688310949681425 flg_digital\n0.007115341768777806 error_baja_monto_prodcatv_bin\n0.005344633457705566 sexo_encoded\n0.01972834568281498 cobre\n0.01494089791609303 sum_tot_importe_arpu_bin_m0\n0.04423150985593923 sum_factura_monto_bruto_m1_bin_m0\n0.0513417688518561 sum_tot_importe_bin\n0.04397126933942889 antic_mora_0_30_t_ohe_m0\n0.010958977424234712 cat_str_hard_mid_user_ohe\n0.012774160068118564 intencion_baja_catv_m0\n0.0019231583074290008 downgrade_cm_m0\n0.0010027408562142083 ret_cm_m0\n0.0038515254286209154 mora_cm_m0\n0.008634605418089846 flag_cumsum_intencion_baja_catv_u6m\n0.0032690062023400883 flag_sum_tot_tipo_prod_catv_totales_danio_m0\n0.0012193290680621745 flag_prod_catv_sum_days_danio_cerrado_m0\n0.008672394047783452 flag_num_promos_fide_prod_all_main_m0\n0.009624964471384523 flag_numacum_promos_fide_prod_all_main_u6m\n0.010037329699927837 flag_num_days_fin_promo_prod_all_main_m0\n0.003845726465053937 flag_sum_days_paid_delay_m0\n0.013490555021272967 flag_sumacum_interact_gestiones_especiales_u6m\n0.008231292687798902 flag_sumacum_interact_fija_u6m\n0.004850146486588056 flag_cumsum_upgrade_cm_u6m\n0.004867379222092136 flag_sum_tot_tipo_prod_cm_abierto_danio_m0\n0.001004139982294706 flag_sum_tot_tipo_prod_cm_infundado_danio_m0\n0.001302780491557224 flag_sum_acum_tot_tipo_prod_cm_infundado_danio_u6m\n46"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_162967<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/</a>"}]},"apps":[],"jobName":"paragraph_1664301576495_1710352149","id":"20220927-145936_2092878254","dateCreated":"2022-09-27T14:59:36-0300","dateStarted":"2022-10-04T11:26:10-0300","dateFinished":"2022-10-04T13:06:23-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8183"},{"text":"%livy.pyspark\nlen(trainingData.columns)","user":"u632820","dateUpdated":"2022-09-30T16:13:00-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"61"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_126103<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_126103/</a>"}]},"apps":[],"jobName":"paragraph_1664557563751_1911089268","id":"20220930-140603_1052169","dateCreated":"2022-09-30T14:06:03-0300","dateStarted":"2022-09-30T14:12:03-0300","dateFinished":"2022-09-30T14:12:04-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8184"},{"text":"%md\n## Entrenamos un RF #2","user":"u632820","dateUpdated":"2022-10-04T14:02:57-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>Entrenamos un RF #2</h2>\n</div>"}]},"apps":[],"jobName":"paragraph_1664902954887_-707118632","id":"20221004-140234_1950117824","dateCreated":"2022-10-04T14:02:34-0300","dateStarted":"2022-10-04T14:02:38-0300","dateFinished":"2022-10-04T14:02:38-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8185"},{"text":"%livy.pyspark\n# Entrenamos un modelo usando cross validation y probando con diferentes hiperparametros para obtener un modelo de challenger que supere al modelo productivo\n# Se probaron hiperparametrizaciones con 150, 200 y 300 árboles. entre 150 y 200 no hay cambios, si mejora medio punto con 300 árboles - 2da prueba 300 y 400 árboles\n# en cuanto a la profundidad de 5 a 10 capas mejora pero a partir de 10 ya comienza a dar idea de overfiting - Se deja fijo en 10 \n\nmodel = RandomForestClassifier(labelCol=\"label_\", featuresCol=\"features\")\n\nevaluator=BinaryClassificationEvaluator()\n\nparamGrid = ParamGridBuilder() \\\n    .addGrid(model.numTrees, [75, 100]) \\\n    .addGrid(model.maxDepth, [10, 12, 15]) \\\n    .addGrid(model.maxBins, [10, 20]) \\\n    .build()\n\n    \ncrossval2 = CrossValidator(estimator=model,\n                          estimatorParamMaps=paramGrid,\n                          evaluator=evaluator,\n                          numFolds=5)  # use 3+ folds in practice\n\nstages = [target_st, assembler,  crossval2 ]\n\npipeline = Pipeline(stages=stages)\n\n# Run cross-validation, and choose the best set of parameters.\ncvModel2 = pipeline.fit(trainingData)","user":"u632820","dateUpdated":"2022-10-03T11:50:34-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_158048<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_158048/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_158048/</a>"}]},"apps":[],"jobName":"paragraph_1664557707852_-841600258","id":"20220930-140827_782393540","dateCreated":"2022-09-30T14:08:27-0300","dateStarted":"2022-10-03T11:50:38-0300","dateFinished":"2022-10-03T17:02:06-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8186"},{"text":"%livy.pyspark\n\n\n\n\"\"\"\nSin Scaler\n\nmodel = RandomForestClassifier(labelCol='label', featuresCol=\"features\")\n\nstages = [target_st, assembler,  crossval2 ]\n\n\"\"\"\n\n\n\"\"\"\nCon Scaler\n\nmodel = RandomForestClassifier(labelCol='label', featuresCol=\"features_scaled\")\n\nstages = [target_st, assembler, scaler, crossval2 ]\n\n\"\"\"\n\n\n# Run the stages as a Pipeline. This puts the data through all of the feature transformations we described in a single call.\n# Entreno el modelo \n\ntestDataScore = cvModel2.transform(testData)\nevaluator.evaluate(testDataScore)\n\n# El mejor modelo entrenado\nbestModel = cvModel2.stages[-1].bestModel\nprint(bestModel.extractParamMap())\n\nprint('--------------------------')\n\nprint(\"Test Area Under ROC: \" + str(evaluator.evaluate(testDataScore, {evaluator.metricName: \"areaUnderROC\"})))\n#https://towardsdatascience.com/machine-learning-with-pyspark-and-mllib-solving-a-binary-classification-problem-96396065d2aa\n\nprint('--------------------------')\n\nimportances = bestModel.featureImportances\nidx = 0\nidx2 = 0\nfor i in importances:\n  idx += 1\n  if i > 0.001:\n    print(i, numericCols[idx])\n    idx2 += 1\nprint(idx2 +1)\n\n\n\n","user":"u632820","dateUpdated":"2022-10-03T11:50:38-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"{Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='cacheNodeIds', doc='If false, the algorithm will pass trees to executors to match instances with nodes. If true, the algorithm will cache node IDs for each instance. Caching can speed up training of deeper trees.'): False, Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='checkpointInterval', doc='set checkpoint interval (>= 1) or disable checkpoint (-1). E.g. 10 means that the cache will get checkpointed every 10 iterations. Note: this setting will be ignored if the checkpoint directory is not set in the SparkContext'): 10, Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='featureSubsetStrategy', doc='The number of features to consider for splits at each tree node. Supported options: auto, all, onethird, sqrt, log2, (0.0-1.0], [1-n].'): 'auto', Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='featuresCol', doc='features column name'): 'features', Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='impurity', doc='Criterion used for information gain calculation (case-insensitive). Supported options: entropy, gini'): 'gini', Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='labelCol', doc='label column name'): 'label_', Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='maxBins', doc='Max number of bins for discretizing continuous features.  Must be >=2 and >= number of categories for any categorical feature.'): 20, Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='maxDepth', doc='Maximum depth of the tree. (>= 0) E.g., depth 0 means 1 leaf node; depth 1 means 1 internal node + 2 leaf nodes.'): 15, Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='maxMemoryInMB', doc='Maximum memory in MB allocated to histogram aggregation.'): 256, Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='minInfoGain', doc='Minimum information gain for a split to be considered at a tree node.'): 0.0, Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='minInstancesPerNode', doc='Minimum number of instances each child must have after split.  If a split causes the left or right child to have fewer than minInstancesPerNode, the split will be discarded as invalid. Should be >= 1.'): 1, Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='numTrees', doc='Number of trees to train (>= 1)'): 100, Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='predictionCol', doc='prediction column name'): 'prediction', Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='probabilityCol', doc='Column name for predicted class conditional probabilities. Note: Not all models output well-calibrated probability estimates! These probabilities should be treated as confidences, not precise probabilities'): 'probability', Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='rawPredictionCol', doc='raw prediction (a.k.a. confidence) column name'): 'rawPrediction', Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='seed', doc='random seed'): -5387697053847413545, Param(parent='RandomForestClassifier_4a69abdae24c6eddb94a', name='subsamplingRate', doc='Fraction of the training data used for learning each decision tree, in range (0, 1].'): 1.0}\n--------------------------\nTest Area Under ROC: 0.6943067344959363\n--------------------------\n0.04866890951361219 avg_zt_cli_viv_u6m\n0.05049233819959178 tend_zt_cli_viv_m6\n0.0544439913769075 avg_rxpower_up_madrugada_m0\n0.04454332957550362 avg_zt_tm_u6m\n0.03637823167034821 sum_kb_up_noche_m0\n0.04116433057619771 prod_catv_antiq\n0.02010381691400366 avg_tot_tipo_prod_catv_totales_danio_u6m\n0.004831793943420877 prod_cm_sum_days_danio_cerrado_m0\n0.009659108477912943 ranking_gam\n0.028700601797665634 tend_kb_down_total_m6\n0.04507260033168517 antiq_cm_zt_m0\n0.04548020165314843 antiq_enabled_dignet_zt_m0\n0.04212940901014176 prod_cm_antiq\n0.010834641342440832 antiq_enabled_serv_zt_m0\n0.04416228358646005 avg_zt_cli_kms_u3m\n0.047654277783003254 compgte_prop_weekend_kb_up_m1\n0.010889700983511778 avg_tot_tipo_prod_cm_cerrado_danio_u6m\n0.005473392415063487 antiguedad_cliente\n0.10108078007752587 flg_flex\n0.005228226639618884 flg_digital\n0.0071328620206251156 error_baja_monto_prodcatv_bin\n0.006313293340348623 sexo_encoded\n0.01810553959338632 cobre\n0.016453326936040458 sum_tot_importe_arpu_bin_m0\n0.04152030886362045 sum_factura_monto_bruto_m1_bin_m0\n0.0439644780198397 sum_tot_importe_bin\n0.03867286289317491 antic_mora_0_30_t_ohe_m0\n0.011421169313534459 cat_str_hard_mid_user_ohe\n0.013006093517771058 intencion_baja_catv_m0\n0.00106064446752377 upgrade_cm_m0\n0.002321952147552385 downgrade_cm_m0\n0.0018296494614099558 ret_cm_m0\n0.004425416268417218 mora_cm_m0\n0.009740939545895505 flag_cumsum_intencion_baja_catv_u6m\n0.004670921939937191 flag_sum_tot_tipo_prod_catv_totales_danio_m0\n0.003318894346525588 flag_prod_catv_sum_days_danio_cerrado_m0\n0.0011974269719412672 flag_prod_catv_sum_days_danio_abierto_m0\n0.010089367549397509 flag_num_promos_fide_prod_all_main_m0\n0.00982461783691658 flag_numacum_promos_fide_prod_all_main_u6m\n0.009906644868079795 flag_num_days_fin_promo_prod_all_main_m0\n0.004155052282512767 flag_sum_days_paid_delay_m0\n0.011169841512767094 flag_sumacum_interact_gestiones_especiales_u6m\n0.008624795384205283 flag_sumacum_interact_fija_u6m\n0.004948180252216603 flag_cumsum_upgrade_cm_u6m\n0.004970927784113032 flag_sum_tot_tipo_prod_cm_abierto_danio_m0\n0.0025371844735908133 flag_sum_tot_tipo_prod_cm_infundado_danio_m0\n0.0014819161517883748 flag_prod_cm_sum_days_danio_cerrado_m0\n0.002004461293974272 flag_sum_acum_tot_tipo_prod_cm_abierto_danio_u6m\n0.003338016415518309 flag_sum_acum_tot_tipo_prod_cm_infundado_danio_u6m\n0.0017842217500583677 flag_sum_acum_tot_tipo_prod_catv_Abierto_danio_u6m\n51"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_158048<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_158048/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_158048/</a>"}]},"apps":[],"jobName":"paragraph_1664559007151_1039973536","id":"20220930-143007_2040855461","dateCreated":"2022-09-30T14:30:07-0300","dateStarted":"2022-10-03T11:50:39-0300","dateFinished":"2022-10-03T17:04:12-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8187"},{"text":"%md\n## Entrenamos un RF #3","user":"u632820","dateUpdated":"2022-10-04T14:02:57-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>Entrenamos un RF #3</h2>\n</div>"}]},"apps":[],"jobName":"paragraph_1664902962581_2102335135","id":"20221004-140242_1302564349","dateCreated":"2022-10-04T14:02:42-0300","dateStarted":"2022-10-04T14:02:45-0300","dateFinished":"2022-10-04T14:02:45-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8188"},{"text":"%livy.pyspark\n# Entrenamos un modelo usando cross validation y probando con diferentes hiperparametros para obtener un modelo de challenger que supere al modelo productivo\n# Se probaron hiperparametrizaciones con 150, 200 y 300 árboles. entre 150 y 200 no hay cambios, si mejora medio punto con 300 árboles - 2da prueba 300 y 400 árboles\n# en cuanto a la profundidad de 5 a 10 capas mejora pero a partir de 10 ya comienza a dar idea de overfiting - Se deja fijo en 10 \n\nmodel = RandomForestClassifier(labelCol=\"label_\", featuresCol=\"features\")\n\nevaluator=BinaryClassificationEvaluator()\n\nparamGrid = ParamGridBuilder() \\\n    .addGrid(model.numTrees, [175, 200]) \\\n    .addGrid(model.maxDepth, [15, 20]) \\\n    .addGrid(model.maxBins, [32]) \\\n    .build()\n\n    \ncrossval2 = CrossValidator(estimator=model,\n                          estimatorParamMaps=paramGrid,\n                          evaluator=evaluator,\n                          numFolds=5)  # use 3+ folds in practice\n\nstages = [target_st, assembler,  crossval2 ]\n\npipeline = Pipeline(stages=stages)\n\n# Run cross-validation, and choose the best set of parameters.\ncvModel2 = pipeline.fit(trainingData)","user":"u632820","dateUpdated":"2022-10-04T00:08:14-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_162967<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/</a>"}]},"apps":[],"jobName":"paragraph_1664816605491_661679007","id":"20221003-140325_630941264","dateCreated":"2022-10-03T14:03:25-0300","dateStarted":"2022-10-04T00:08:14-0300","dateFinished":"2022-10-04T10:47:01-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8189"},{"text":"%livy.pyspark\n\n\n\n\"\"\"\nSin Scaler\n\nmodel = RandomForestClassifier(labelCol='label', featuresCol=\"features\")\n\nstages = [target_st, assembler,  crossval2 ]\n\n\"\"\"\n\n\n\"\"\"\nCon Scaler\n\nmodel = RandomForestClassifier(labelCol='label', featuresCol=\"features_scaled\")\n\nstages = [target_st, assembler, scaler, crossval2 ]\n\n\"\"\"\n\n\n# Run the stages as a Pipeline. This puts the data through all of the feature transformations we described in a single call.\n# Entreno el modelo \n\ntestDataScore = cvModel2.transform(testData)\nevaluator.evaluate(testDataScore)\n\n# El mejor modelo entrenado\nbestModel = cvModel2.stages[-1].bestModel\nprint(bestModel.extractParamMap())\n\nprint('--------------------------')\n\nprint(\"Test Area Under ROC: \" + str(evaluator.evaluate(testDataScore, {evaluator.metricName: \"areaUnderROC\"})))\n#https://towardsdatascience.com/machine-learning-with-pyspark-and-mllib-solving-a-binary-classification-problem-96396065d2aa\n\nprint('--------------------------')\n\nimportances = bestModel.featureImportances\nidx = 0\nidx2 = 0\nfor i in importances:\n  idx += 1\n  if i > 0.001:\n    print(i, numericCols[idx])\n    idx2 += 1\nprint(idx2 +1)","user":"u632820","dateUpdated":"2022-10-04T00:08:17-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"{Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='cacheNodeIds', doc='If false, the algorithm will pass trees to executors to match instances with nodes. If true, the algorithm will cache node IDs for each instance. Caching can speed up training of deeper trees.'): False, Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='checkpointInterval', doc='set checkpoint interval (>= 1) or disable checkpoint (-1). E.g. 10 means that the cache will get checkpointed every 10 iterations. Note: this setting will be ignored if the checkpoint directory is not set in the SparkContext'): 10, Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='featureSubsetStrategy', doc='The number of features to consider for splits at each tree node. Supported options: auto, all, onethird, sqrt, log2, (0.0-1.0], [1-n].'): 'auto', Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='featuresCol', doc='features column name'): 'features', Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='impurity', doc='Criterion used for information gain calculation (case-insensitive). Supported options: entropy, gini'): 'gini', Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='labelCol', doc='label column name'): 'label_', Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='maxBins', doc='Max number of bins for discretizing continuous features.  Must be >=2 and >= number of categories for any categorical feature.'): 32, Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='maxDepth', doc='Maximum depth of the tree. (>= 0) E.g., depth 0 means 1 leaf node; depth 1 means 1 internal node + 2 leaf nodes.'): 20, Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='maxMemoryInMB', doc='Maximum memory in MB allocated to histogram aggregation.'): 256, Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='minInfoGain', doc='Minimum information gain for a split to be considered at a tree node.'): 0.0, Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='minInstancesPerNode', doc='Minimum number of instances each child must have after split.  If a split causes the left or right child to have fewer than minInstancesPerNode, the split will be discarded as invalid. Should be >= 1.'): 1, Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='numTrees', doc='Number of trees to train (>= 1)'): 200, Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='predictionCol', doc='prediction column name'): 'prediction', Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='probabilityCol', doc='Column name for predicted class conditional probabilities. Note: Not all models output well-calibrated probability estimates! These probabilities should be treated as confidences, not precise probabilities'): 'probability', Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='rawPredictionCol', doc='raw prediction (a.k.a. confidence) column name'): 'rawPrediction', Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='seed', doc='random seed'): -5387697053847413545, Param(parent='RandomForestClassifier_414fbff88cff6494be63', name='subsamplingRate', doc='Fraction of the training data used for learning each decision tree, in range (0, 1].'): 1.0}\n--------------------------\nTest Area Under ROC: 0.7179454876092285\n--------------------------\n0.06506252750740475 avg_zt_cli_viv_u6m\n0.06182569406058497 tend_zt_cli_viv_m6\n0.05536584249352632 avg_rxpower_up_madrugada_m0\n0.055071467098560534 avg_zt_tm_u6m\n0.017895349649660438 sum_kb_up_noche_m0\n0.05141936196016757 prod_catv_antiq\n0.007794589130726437 avg_tot_tipo_prod_catv_totales_danio_u6m\n0.0019143269345266185 prod_cm_sum_days_danio_cerrado_m0\n0.003903611005035762 ranking_gam\n0.035226490054055 tend_kb_down_total_m6\n0.054854074510568736 antiq_cm_zt_m0\n0.04653750943184038 antiq_enabled_dignet_zt_m0\n0.04122441323967301 prod_cm_antiq\n0.006497891532898109 antiq_enabled_serv_zt_m0\n0.04893052000677272 avg_zt_cli_kms_u3m\n0.05801593045850523 compgte_prop_weekend_kb_up_m1\n0.013318189251832221 avg_tot_tipo_prod_cm_cerrado_danio_u6m\n0.0021242765518889187 antiguedad_cliente\n0.06948596254421502 flg_flex\n0.0030289190575811037 flg_digital\n0.006908875665220137 error_baja_monto_prodcatv_bin\n0.005438546357312162 sexo_encoded\n0.019836978774376294 cobre\n0.014734229419049115 sum_tot_importe_arpu_bin_m0\n0.04440938128371784 sum_factura_monto_bruto_m1_bin_m0\n0.05142463200411722 sum_tot_importe_bin\n0.04434175445779628 antic_mora_0_30_t_ohe_m0\n0.010817370085303386 cat_str_hard_mid_user_ohe\n0.012615344274090804 intencion_baja_catv_m0\n0.0019091080422044327 downgrade_cm_m0\n0.0010012082199569463 ret_cm_m0\n0.0038550577944835734 mora_cm_m0\n0.008585443274006743 flag_cumsum_intencion_baja_catv_u6m\n0.0032148779574912604 flag_sum_tot_tipo_prod_catv_totales_danio_m0\n0.0011783796861894397 flag_prod_catv_sum_days_danio_cerrado_m0\n0.008631835538832414 flag_num_promos_fide_prod_all_main_m0\n0.00957706046651085 flag_numacum_promos_fide_prod_all_main_u6m\n0.010052793077208643 flag_num_days_fin_promo_prod_all_main_m0\n0.003789496599635167 flag_sum_days_paid_delay_m0\n0.013428989162824536 flag_sumacum_interact_gestiones_especiales_u6m\n0.007954678072573836 flag_sumacum_interact_fija_u6m\n0.0047271693759598325 flag_cumsum_upgrade_cm_u6m\n0.004899127685622077 flag_sum_tot_tipo_prod_cm_abierto_danio_m0\n0.0012825072258320091 flag_sum_acum_tot_tipo_prod_cm_infundado_danio_u6m\n45"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_162967<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_162967/</a>"}]},"apps":[],"jobName":"paragraph_1664816625661_-1106676138","id":"20221003-140345_773197903","dateCreated":"2022-10-03T14:03:45-0300","dateStarted":"2022-10-04T00:08:17-0300","dateFinished":"2022-10-04T11:00:07-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8190"},{"text":"%md\n## ENtrenamos un GBT\n","user":"u632820","dateUpdated":"2022-10-04T14:02:52-0300","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h2>ENtrenamos un GBT</h2>\n</div>"}]},"apps":[],"jobName":"paragraph_1664299294382_-784171084","id":"20220819-101239_728279027","dateCreated":"2022-09-27T14:21:34-0300","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:8191"},{"text":"%livy.pyspark\n# Entrenamos un modelo Gradien boosting classfier usando cross validation y probando con diferentes hiperparametros para obtener un modelo de challenger que supere al modelo productivo\n\nmodel = GBTClassifier(labelCol='label_', featuresCol=\"features\", seed=SEED)\n\nevaluator=BinaryClassificationEvaluator()\n\n\n# Define a grid of hyperparameters to test:\n#  - maxDepth: max depth of each decision tree in the GBT ensemble\n#  - maxIter: iterations, i.e., number of trees in each GBT ensemble\n# In this example notebook, we keep these values small.  In practice, to get the highest accuracy, you would likely want to try deeper trees (10 or higher) and more trees in the ensemble (>100)\n\n\nparamGrid = ParamGridBuilder() \\\n    .addGrid(model.maxIter, [100]) \\\n    .addGrid(model.maxDepth, [3, 5]) \\\n    .addGrid(model.maxBins, [32]) \\\n    .build()\n    \n\ncrossval = CrossValidator(estimator=model,\n                          estimatorParamMaps=paramGrid,\n                          evaluator=evaluator,\n                          numFolds=3)  # use 3+ folds in practice\n\n\nstages = [target_st, assembler, crossval ]\n\npipeline = Pipeline(stages=stages)\n\n# Run cross-validation, and choose the best set of parameters.\ncvModel = pipeline.fit(trainingData)\n\n# Este tardaba 9 horas!!!","user":"u632820","dateUpdated":"2022-09-30T16:13:00-0300","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true,"editorHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_102917<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_102917/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_102917/</a>"}]},"apps":[],"jobName":"paragraph_1664299294384_-1169187684","id":"20220819-100920_946290661","dateCreated":"2022-09-27T14:21:34-0300","dateStarted":"2022-09-28T00:05:58-0300","dateFinished":"2022-09-28T01:12:31-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8192"},{"text":"%livy.pyspark\n\n# limpiar el DS \n\ntrain_undersampled_df.unpersist","user":"u632820","dateUpdated":"2022-09-30T16:13:00-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python","editorHide":false},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1664474618746_-1134946788","id":"20220929-150338_964085315","dateCreated":"2022-09-29T15:03:38-0300","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:8193"},{"text":"%md\n\n# Corro lo mismo con una base mas chica\n","user":"u632820","dateUpdated":"2022-10-05T16:31:26-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"editorMode":"ace/mode/markdown","editorHide":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Corro lo mismo con una base mas chica</h1>\n</div>"}]},"apps":[],"jobName":"paragraph_1664998177833_542519346","id":"20221005-162937_1716060","dateCreated":"2022-10-05T16:29:37-0300","dateStarted":"2022-10-05T16:31:26-0300","dateFinished":"2022-10-05T16:31:28-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8194"},{"text":"%livy.pyspark\n\n#separo Train y Test\n\n(trainingData, testData) = train_undersampled_df.randomSplit([0.3, 0.7], seed=1234)\n\nprint(\"TRAIN Shape: \" , trainingData.count())","user":"u632820","dateUpdated":"2022-10-05T16:31:41-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"TRAIN Shape:  533359"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664998170601_-350557083","id":"20221005-162930_1199205590","dateCreated":"2022-10-05T16:29:30-0300","dateStarted":"2022-10-05T16:31:41-0300","dateFinished":"2022-10-05T16:31:53-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8195"},{"text":"%livy.pyspark\n\n# Grabo la base con las columnas que no estan correlacionadas\n\ntrainingData.write.mode('overwrite').format('parquet').saveAsTable('sdb_datamining.tempna_abtimputadaCATVHD2_m_seba_sinCorr_3p')\n","user":"u632820","dateUpdated":"2022-10-05T16:34:16-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664998301782_-891990841","id":"20221005-163141_1495989290","dateCreated":"2022-10-05T16:31:41-0300","dateStarted":"2022-10-05T16:34:16-0300","dateFinished":"2022-10-05T16:34:30-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8196"},{"text":"%livy.pyspark\r\n\r\ntrainingData= spark.sql(\" select * from sdb_datamining.tempna_abtimputadaCATVHD2_m_seba_sinCorr_3p\")\r\nprint(\"Number of partitions PARTY: {}\".format(trainingData.rdd.getNumPartitions()))\r\ntrainingData = trainingData.coalesce(4)\r\nprint(\"Number of partitions PARTY: {}\".format(trainingData.rdd.getNumPartitions()))\r\n","user":"u632820","dateUpdated":"2022-10-05T16:39:14-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Number of partitions PARTY: 7\nNumber of partitions PARTY: 4"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664998456058_-1485455934","id":"20221005-163416_815352541","dateCreated":"2022-10-05T16:34:16-0300","dateStarted":"2022-10-05T16:39:14-0300","dateFinished":"2022-10-05T16:39:15-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8197"},{"text":"\r\n%livy.pyspark\r\nimport pyspark.sql.functions as F\r\n\r\n# Las particiones tienen que ser parejas...\r\n\r\ntrainingData.groupBy(F.spark_partition_id()).count().show()\r\n\r\n# https://towardsdatascience.com/data-skew-in-pyspark-783d529a9dd7\r\n\r\n","user":"u632820","dateUpdated":"2022-10-05T16:39:21-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+------+\n|SPARK_PARTITION_ID()| count|\n+--------------------+------+\n|                   1|193282|\n|                   3| 67993|\n|                   2|123106|\n|                   0|148978|\n+--------------------+------+"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664998481710_-2055634658","id":"20221005-163441_766754534","dateCreated":"2022-10-05T16:34:41-0300","dateStarted":"2022-10-05T16:39:21-0300","dateFinished":"2022-10-05T16:39:29-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8198"},{"text":"%livy.pyspark\r\n# Entrenamos un modelo usando cross validation y probando con diferentes hiperparametros para obtener un modelo de challenger que supere al modelo productivo\r\n# Se probaron hiperparametrizaciones con 150, 200 y 300 árboles. entre 150 y 200 no hay cambios, si mejora medio punto con 300 árboles - 2da prueba 300 y 400 árboles\r\n# en cuanto a la profundidad de 5 a 10 capas mejora pero a partir de 10 ya comienza a dar idea de overfiting - Se deja fijo en 10 \r\n\r\nmodel = RandomForestClassifier(labelCol=\"label_\", featuresCol=\"features\")\r\n\r\nevaluator=BinaryClassificationEvaluator()\r\n\r\nparamGrid = ParamGridBuilder() \\\r\n    .addGrid(model.numTrees, [100]) \\\r\n    .addGrid(model.maxDepth, [20]) \\\r\n    .addGrid(model.maxBins, [32]) \\\r\n    .build()\r\n\r\n    \r\ncrossval2 = CrossValidator(estimator=model,\r\n                          estimatorParamMaps=paramGrid,\r\n                          evaluator=evaluator,\r\n                          numFolds=3)  # use 3+ folds in practice\r\n\r\nstages = [target_st, assembler,  crossval2 ]\r\n\r\npipeline = Pipeline(stages=stages)\r\n\r\n# Run cross-validation, and choose the best set of parameters.\r\ncvModel2 = pipeline.fit(trainingData)\r\n","user":"u632820","dateUpdated":"2022-10-05T16:40:07-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664998672330_1324356648","id":"20221005-163752_918257585","dateCreated":"2022-10-05T16:37:52-0300","dateStarted":"2022-10-05T16:40:07-0300","dateFinished":"2022-10-05T17:34:56-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8199"},{"text":"%livy.pyspark\r\n\r\n\r\n# Run the stages as a Pipeline. This puts the data through all of the feature transformations we described in a single call.\r\n# Entreno el modelo \r\n\r\ntestDataScore = cvModel2.transform(testData)\r\nevaluator.evaluate(testDataScore)\r\n\r\n# El mejor modelo entrenado\r\nbestModel = cvModel2.stages[-1].bestModel\r\nprint(bestModel.extractParamMap())\r\n\r\nprint('--------------------------')\r\n\r\nprint(\"Test Area Under ROC: \" + str(evaluator.evaluate(testDataScore, {evaluator.metricName: \"areaUnderROC\"})))\r\n#https://towardsdatascience.com/machine-learning-with-pyspark-and-mllib-solving-a-binary-classification-problem-96396065d2aa\r\n\r\nprint('--------------------------')\r\n\r\nimportances = bestModel.featureImportances\r\nidx = 0\r\nidx2 = 0\r\nfor i in importances:\r\n  idx += 1\r\n  if i > 0.001:\r\n    print(i, numericCols[idx])\r\n    idx2 += 1\r\nprint(idx2 +1)\r\n\r\n","user":"u632820","dateUpdated":"2022-10-05T16:40:27-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"{Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='cacheNodeIds', doc='If false, the algorithm will pass trees to executors to match instances with nodes. If true, the algorithm will cache node IDs for each instance. Caching can speed up training of deeper trees.'): False, Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='checkpointInterval', doc='set checkpoint interval (>= 1) or disable checkpoint (-1). E.g. 10 means that the cache will get checkpointed every 10 iterations. Note: this setting will be ignored if the checkpoint directory is not set in the SparkContext'): 10, Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='featureSubsetStrategy', doc='The number of features to consider for splits at each tree node. Supported options: auto, all, onethird, sqrt, log2, (0.0-1.0], [1-n].'): 'auto', Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='featuresCol', doc='features column name'): 'features', Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='impurity', doc='Criterion used for information gain calculation (case-insensitive). Supported options: entropy, gini'): 'gini', Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='labelCol', doc='label column name'): 'label_', Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='maxBins', doc='Max number of bins for discretizing continuous features.  Must be >=2 and >= number of categories for any categorical feature.'): 32, Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='maxDepth', doc='Maximum depth of the tree. (>= 0) E.g., depth 0 means 1 leaf node; depth 1 means 1 internal node + 2 leaf nodes.'): 20, Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='maxMemoryInMB', doc='Maximum memory in MB allocated to histogram aggregation.'): 256, Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='minInfoGain', doc='Minimum information gain for a split to be considered at a tree node.'): 0.0, Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='minInstancesPerNode', doc='Minimum number of instances each child must have after split.  If a split causes the left or right child to have fewer than minInstancesPerNode, the split will be discarded as invalid. Should be >= 1.'): 1, Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='numTrees', doc='Number of trees to train (>= 1)'): 100, Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='predictionCol', doc='prediction column name'): 'prediction', Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='probabilityCol', doc='Column name for predicted class conditional probabilities. Note: Not all models output well-calibrated probability estimates! These probabilities should be treated as confidences, not precise probabilities'): 'probability', Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='rawPredictionCol', doc='raw prediction (a.k.a. confidence) column name'): 'rawPrediction', Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='seed', doc='random seed'): -5387697053847413545, Param(parent='RandomForestClassifier_4c2990e459ec00223c5b', name='subsamplingRate', doc='Fraction of the training data used for learning each decision tree, in range (0, 1].'): 1.0}\n--------------------------\nTest Area Under ROC: 0.6870260793305922\n--------------------------\n0.06626321924868608 avg_zt_cli_viv_u6m\n0.06284149541600179 tend_zt_cli_viv_m6\n0.05661701442222657 avg_rxpower_up_madrugada_m0\n0.05546007905892843 avg_zt_tm_u6m\n0.01682866793348233 sum_kb_up_noche_m0\n0.05204143310778584 prod_catv_antiq\n0.00668779747367462 avg_tot_tipo_prod_catv_totales_danio_u6m\n0.001524330466759227 prod_cm_sum_days_danio_cerrado_m0\n0.0029342001039862065 ranking_gam\n0.03590841314407618 tend_kb_down_total_m6\n0.0557165390253103 antiq_cm_zt_m0\n0.047766366213172255 antiq_enabled_dignet_zt_m0\n0.04293819136467573 prod_cm_antiq\n0.0061339145612337225 antiq_enabled_serv_zt_m0\n0.05011814284519288 avg_zt_cli_kms_u3m\n0.058884372551416236 compgte_prop_weekend_kb_up_m1\n0.013883127526271626 avg_tot_tipo_prod_cm_cerrado_danio_u6m\n0.0018791553226988225 antiguedad_cliente\n0.06466914578423189 flg_flex\n0.0028705520468464696 flg_digital\n0.0066795033237310305 error_baja_monto_prodcatv_bin\n0.004901156928086706 sexo_encoded\n0.020057087229995763 cobre\n0.01483518261914263 sum_tot_importe_arpu_bin_m0\n0.04409957867136276 sum_factura_monto_bruto_m1_bin_m0\n0.050929763600833726 sum_tot_importe_bin\n0.04481537448604182 antic_mora_0_30_t_ohe_m0\n0.010409965857378835 cat_str_hard_mid_user_ohe\n0.013037681644940728 intencion_baja_catv_m0\n0.001993368376776456 downgrade_cm_m0\n0.0010721231218320452 ret_cm_m0\n0.0035183189561391313 mora_cm_m0\n0.00899139495541485 flag_cumsum_intencion_baja_catv_u6m\n0.0030793503317704455 flag_sum_tot_tipo_prod_catv_totales_danio_m0\n0.0010106933811188533 flag_prod_catv_sum_days_danio_cerrado_m0\n0.008216655200922794 flag_num_promos_fide_prod_all_main_m0\n0.009591862177675005 flag_numacum_promos_fide_prod_all_main_u6m\n0.010029415203010178 flag_num_days_fin_promo_prod_all_main_m0\n0.003603151335191518 flag_sum_days_paid_delay_m0\n0.013874208764258569 flag_sumacum_interact_gestiones_especiales_u6m\n0.0076827936917315655 flag_sumacum_interact_fija_u6m\n0.0043294025039288635 flag_cumsum_upgrade_cm_u6m\n0.004769452910961282 flag_sum_tot_tipo_prod_cm_abierto_danio_m0\n0.0010843633396122154 flag_sum_acum_tot_tipo_prod_cm_infundado_danio_u6m\n45"},{"type":"HTML","data":"<hr/>Spark Application Id: application_1663324482137_181028<br/>Spark WebUI: <a href=\"http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/\">http://sr-hadctl-xp03.corp.cablevision.com.ar:8088/proxy/application_1663324482137_181028/</a>"}]},"apps":[],"jobName":"paragraph_1664998807029_887265327","id":"20221005-164007_911679026","dateCreated":"2022-10-05T16:40:07-0300","dateStarted":"2022-10-05T16:40:27-0300","dateFinished":"2022-10-05T17:41:13-0300","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:8200"},{"text":"%livy.pyspark\n","user":"u632820","dateUpdated":"2022-10-05T16:40:27-0300","config":{"colWidth":12,"fontSize":9,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1664998827825_-1718003338","id":"20221005-164027_872168818","dateCreated":"2022-10-05T16:40:27-0300","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:8201"}],"name":"_Nalcoleas/Churn_CatvHd/ Train sample/Challenger train models_Sebas","id":"2HFUJZCGS","noteParams":{},"noteForms":{},"angularObjects":{"md:shared_process":[],"spark:shared_process":[],"livy:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":true,"looknfeel":"default","personalizedMode":"false"},"info":{}}